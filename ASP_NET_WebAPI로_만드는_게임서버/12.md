# ASP.NET Core Web API로 게임 서버 개발
  
저자: 최흥배, Claude AI   
-----------------------    
   
# Chapter 12. 전투 시스템 설계

## 12.1 전투 시스템 개요
수집형 RPG 게임에서 전투 시스템은 핵심 게임플레이 메커니즘이다. 플레이어는 수집한 캐릭터를 통해 다양한 전투 콘텐츠에 도전하고, 승리를 통해 보상을 획득한다. 이 장에서는 서버 측에서 전투 시스템을 처리하는 방법을 다룬다.
  
### 12.1.1 서버 기반 전투 시스템의 특징
서버 기반 전투 시스템은 다음과 같은 장점을 제공한다:  
  
1. **보안성**: 치팅이나 불법 조작을 방지할 수 있다.
2. **일관성**: 모든 플레이어에게 동일한 규칙과 결과를 보장한다.
3. **데이터 관리**: 전투 기록과 통계를 중앙에서 수집하고 분석할 수 있다.

반면, 다음과 같은 고려사항도 있다:

1. **서버 부하**: 복잡한 전투 계산은 서버 리소스를 많이 소모할 수 있다.
2. **응답 시간**: 클라이언트는 전투 결과를 받기 위해 서버 응답을 기다려야 한다.
3. **네트워크 의존성**: 네트워크 상태에 따라 게임 경험이 영향을 받을 수 있다.

### 12.1.2 전투 시스템 설계 방식
수집형 RPG 게임의 전투 시스템은 크게 두 가지 방식으로 접근할 수 있다:

1. **시뮬레이션 방식**: 서버에서 전투의 모든 단계와 행동을 시뮬레이션하며 진행
2. **결과 계산 방식**: 초기 상태와 규칙을 기반으로 최종 결과만 계산

이 장에서는 서버 부하를 고려하여 주로 결과 계산 방식을 다루되, 중요한 전투 과정 정보도 함께 제공하는 하이브리드 접근법을 사용한다.
    
  
## 12.2 전투 데이터 모델링

### 12.2.1 MySQL 테이블 설계
전투 관련 데이터베이스 테이블을 설계한다:

```sql
-- 전투 기록 테이블
CREATE TABLE battle_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    player_id BIGINT NOT NULL,
    battle_type TINYINT NOT NULL COMMENT '1-PVE, 2-PVP, 3-레이드, 4-길드전',
    stage_id INT NULL COMMENT 'PVE일 경우 스테이지 ID',
    opponent_id BIGINT NULL COMMENT 'PVP일 경우 상대 플레이어 ID',
    result TINYINT NOT NULL COMMENT '1-승리, 2-패배, 3-무승부',
    battle_time INT NOT NULL COMMENT '전투 시간(초)',
    total_damage INT NOT NULL,
    clear_time TIMESTAMP NOT NULL,
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_player_id (player_id),
    INDEX idx_battle_type (battle_type),
    INDEX idx_created_at (created_at)
);

-- 전투 상세 정보 테이블
CREATE TABLE battle_details (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    battle_record_id BIGINT NOT NULL,
    team_type TINYINT NOT NULL COMMENT '1-아군, 2-적군',
    position TINYINT NOT NULL COMMENT '캐릭터 포지션 (0-4)',
    character_id INT NOT NULL,
    character_level INT NOT NULL,
    start_hp INT NOT NULL,
    end_hp INT NOT NULL,
    damage_dealt INT NOT NULL,
    damage_taken INT NOT NULL,
    healing_done INT NOT NULL,
    skill_used JSON NOT NULL COMMENT '사용한 스킬 정보',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 전투 이벤트 로그 테이블
CREATE TABLE battle_event_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    battle_record_id BIGINT NOT NULL,
    event_type TINYINT NOT NULL COMMENT '1-일반공격, 2-스킬사용, 3-상태변화, 4-사망',
    turn INT NOT NULL,
    source_team TINYINT NOT NULL,
    source_position TINYINT NOT NULL,
    target_team TINYINT NOT NULL,
    target_position TINYINT NOT NULL,
    skill_id INT NULL,
    value INT NULL COMMENT '데미지 또는 치유량',
    effect_id INT NULL COMMENT '적용된 효과 ID',
    effect_duration INT NULL COMMENT '효과 지속시간',
    event_time TIMESTAMP NOT NULL, 
    INDEX idx_battle_record_id_turn (battle_record_id, turn)
);

-- 전투 보상 테이블
CREATE TABLE battle_rewards (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    battle_record_id BIGINT NOT NULL,
    reward_type TINYINT NOT NULL COMMENT '1-경험치, 2-골드, 3-아이템, 4-캐릭터',
    item_id INT NULL,
    item_type TINYINT NULL,
    quantity INT NOT NULL,
    is_claimed BOOLEAN NOT NULL DEFAULT FALSE,
    claimed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_battle_record_id (battle_record_id)
);

-- 스테이지 정보 테이블
CREATE TABLE battle_stages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    stage_code VARCHAR(50) NOT NULL,
    chapter INT NOT NULL,
    stage_number INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    difficulty TINYINT NOT NULL COMMENT '1-쉬움, 2-보통, 3-어려움',
    enemy_level INT NOT NULL,
    enemy_team JSON NOT NULL COMMENT '적 팀 구성',
    first_clear_rewards JSON NULL COMMENT '첫 클리어 보상',
    normal_rewards JSON NOT NULL COMMENT '일반 보상',
    stamina_cost INT NOT NULL,
    exp_reward INT NOT NULL,
    gold_reward INT NOT NULL,
    unlock_condition JSON NULL COMMENT '해금 조건',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uq_chapter_stage (chapter, stage_number)
);

-- 적 캐릭터 정보 테이블
CREATE TABLE enemy_characters (
    id INT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    level INT NOT NULL,
    rarity TINYINT NOT NULL,
    element TINYINT NOT NULL,
    attack INT NOT NULL,
    defense INT NOT NULL,
    hp INT NOT NULL,
    speed INT NOT NULL,
    skills JSON NOT NULL COMMENT '스킬 ID 목록',
    ai_type TINYINT NOT NULL COMMENT 'AI 유형',
    is_boss BOOLEAN NOT NULL DEFAULT FALSE,
    special_abilities JSON NULL COMMENT '특수 능력',
    drop_table JSON NULL COMMENT '드롭 테이블',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 12.2.2 엔티티 클래스 설계
MySQL 테이블에 매핑되는 엔티티 클래스를 작성한다:

```csharp
// Models/Battle/BattleRecord.cs
public class BattleRecord
{
    public long Id { get; set; }
    public long PlayerId { get; set; }
    public byte BattleType { get; set; }
    public int? StageId { get; set; }
    public long? OpponentId { get; set; }
    public byte Result { get; set; }
    public int BattleTime { get; set; }
    public int TotalDamage { get; set; }
    public DateTime ClearTime { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // 상수 정의
    public const byte BATTLE_TYPE_PVE = 1;
    public const byte BATTLE_TYPE_PVP = 2;
    public const byte BATTLE_TYPE_RAID = 3;
    public const byte BATTLE_TYPE_GUILD = 4;
    
    public const byte RESULT_WIN = 1;
    public const byte RESULT_LOSE = 2;
    public const byte RESULT_DRAW = 3;
}

// Models/Battle/BattleDetail.cs
public class BattleDetail
{
    public long Id { get; set; }
    public long BattleRecordId { get; set; }
    public byte TeamType { get; set; }
    public byte Position { get; set; }
    public int CharacterId { get; set; }
    public int CharacterLevel { get; set; }
    public int StartHp { get; set; }
    public int EndHp { get; set; }
    public int DamageDealt { get; set; }
    public int DamageTaken { get; set; }
    public int HealingDone { get; set; }
    public string SkillUsed { get; set; } // JSON 문자열
    public DateTime CreatedAt { get; set; }
    
    // JSON 속성 핸들링을 위한 확장 속성
    public Dictionary<int, int> SkillUsedDict
    {
        get => string.IsNullOrEmpty(SkillUsed) 
            ? new Dictionary<int, int>() 
            : System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, int>>(SkillUsed);
        set => SkillUsed = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    // 상수 정의
    public const byte TEAM_ALLY = 1;
    public const byte TEAM_ENEMY = 2;
}

// Models/Battle/BattleEventLog.cs
public class BattleEventLog
{
    public long Id { get; set; }
    public long BattleRecordId { get; set; }
    public byte EventType { get; set; }
    public int Turn { get; set; }
    public byte SourceTeam { get; set; }
    public byte SourcePosition { get; set; }
    public byte TargetTeam { get; set; }
    public byte TargetPosition { get; set; }
    public int? SkillId { get; set; }
    public int? Value { get; set; }
    public int? EffectId { get; set; }
    public int? EffectDuration { get; set; }
    public DateTime EventTime { get; set; }
    
    // 상수 정의
    public const byte EVENT_ATTACK = 1;
    public const byte EVENT_SKILL = 2;
    public const byte EVENT_STATUS = 3;
    public const byte EVENT_DEATH = 4;
}

// Models/Battle/BattleReward.cs
public class BattleReward
{
    public long Id { get; set; }
    public long BattleRecordId { get; set; }
    public byte RewardType { get; set; }
    public int? ItemId { get; set; }
    public byte? ItemType { get; set; }
    public int Quantity { get; set; }
    public bool IsClaimed { get; set; }
    public DateTime? ClaimedAt { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // 상수 정의
    public const byte REWARD_EXPERIENCE = 1;
    public const byte REWARD_GOLD = 2;
    public const byte REWARD_ITEM = 3;
    public const byte REWARD_CHARACTER = 4;
}

// Models/Battle/BattleStage.cs
public class BattleStage
{
    public int Id { get; set; }
    public string StageCode { get; set; }
    public int Chapter { get; set; }
    public int StageNumber { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public byte Difficulty { get; set; }
    public int EnemyLevel { get; set; }
    public string EnemyTeam { get; set; } // JSON 문자열
    public string FirstClearRewards { get; set; } // JSON 문자열
    public string NormalRewards { get; set; } // JSON 문자열
    public int StaminaCost { get; set; }
    public int ExpReward { get; set; }
    public int GoldReward { get; set; }
    public string UnlockCondition { get; set; } // JSON 문자열
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // JSON 속성 처리를 위한 확장 속성
    public List<EnemyPosition> EnemyTeamData
    {
        get => string.IsNullOrEmpty(EnemyTeam) 
            ? new List<EnemyPosition>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<EnemyPosition>>(EnemyTeam);
        set => EnemyTeam = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    public List<StageReward> FirstClearRewardsData
    {
        get => string.IsNullOrEmpty(FirstClearRewards) 
            ? new List<StageReward>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<StageReward>>(FirstClearRewards);
        set => FirstClearRewards = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    public List<StageReward> NormalRewardsData
    {
        get => string.IsNullOrEmpty(NormalRewards) 
            ? new List<StageReward>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<StageReward>>(NormalRewards);
        set => NormalRewards = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    public StageUnlockCondition UnlockConditionData
    {
        get => string.IsNullOrEmpty(UnlockCondition) 
            ? new StageUnlockCondition() 
            : System.Text.Json.JsonSerializer.Deserialize<StageUnlockCondition>(UnlockCondition);
        set => UnlockCondition = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    // 상수 정의
    public const byte DIFFICULTY_EASY = 1;
    public const byte DIFFICULTY_NORMAL = 2;
    public const byte DIFFICULTY_HARD = 3;
}

// Models/Battle/EnemyCharacter.cs
public class EnemyCharacter
{
    public int Id { get; set; }
    public string Code { get; set; }
    public string Name { get; set; }
    public int Level { get; set; }
    public byte Rarity { get; set; }
    public byte Element { get; set; }
    public int Attack { get; set; }
    public int Defense { get; set; }
    public int Hp { get; set; }
    public int Speed { get; set; }
    public string Skills { get; set; } // JSON 문자열
    public byte AiType { get; set; }
    public bool IsBoss { get; set; }
    public string SpecialAbilities { get; set; } // JSON 문자열
    public string DropTable { get; set; } // JSON 문자열
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    // JSON 속성 처리를 위한 확장 속성
    public List<int> SkillsData
    {
        get => string.IsNullOrEmpty(Skills) 
            ? new List<int>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<int>>(Skills);
        set => Skills = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    public List<EnemyAbility> SpecialAbilitiesData
    {
        get => string.IsNullOrEmpty(SpecialAbilities) 
            ? new List<EnemyAbility>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<EnemyAbility>>(SpecialAbilities);
        set => SpecialAbilities = System.Text.Json.JsonSerializer.Serialize(value);
    }
    
    public List<EnemyDrop> DropTableData
    {
        get => string.IsNullOrEmpty(DropTable) 
            ? new List<EnemyDrop>() 
            : System.Text.Json.JsonSerializer.Deserialize<List<EnemyDrop>>(DropTable);
        set => DropTable = System.Text.Json.JsonSerializer.Serialize(value);
    }
}

// 보조 데이터 클래스들
public class EnemyPosition
{
    public int EnemyId { get; set; }
    public byte Position { get; set; }
    public int? Level { get; set; } // null이면 스테이지 기본 레벨 사용
}

public class StageReward
{
    public byte RewardType { get; set; }
    public int ItemId { get; set; }
    public int Quantity { get; set; }
    public double DropRate { get; set; } // 1.0 = 100%, 0.5 = 50%
}

public class StageUnlockCondition
{
    public int? RequiredStageId { get; set; }
    public int? RequiredPlayerLevel { get; set; }
    public List<int> RequiredQuestIds { get; set; } = new List<int>();
}

public class EnemyAbility
{
    public string AbilityCode { get; set; }
    public int Value { get; set; }
    public string Description { get; set; }
}

public class EnemyDrop
{
    public byte DropType { get; set; } // 1-아이템, 2-장비, 3-캐릭터
    public int ItemId { get; set; }
    public int MinQuantity { get; set; }
    public int MaxQuantity { get; set; }
    public double DropRate { get; set; }
}
```

### 12.2.3 전투 데이터 모델 설계
전투 계산에 사용될 인메모리 데이터 모델을 설계한다:

```csharp
// Models/Battle/BattleModels.cs

// 전투 참가 캐릭터 정보
public class BattleCharacter
{
    public int Id { get; set; }
    public string Name { get; set; }
    public byte Team { get; set; } // 1-아군, 2-적군
    public byte Position { get; set; }
    public int Level { get; set; }
    public int MaxHp { get; set; }
    public int CurrentHp { get; set; }
    public int Attack { get; set; }
    public int Defense { get; set; }
    public int Speed { get; set; }
    public byte Element { get; set; }
    public List<int> Skills { get; set; }
    public bool IsAlive => CurrentHp > 0;
    
    // 전투 중 추적되는 통계
    public int DamageDealt { get; set; }
    public int DamageTaken { get; set; }
    public int HealingDone { get; set; }
    public Dictionary<int, int> SkillUseCount { get; set; } = new Dictionary<int, int>();
    
    // 상태 효과 목록
    public List<StatusEffect> StatusEffects { get; set; } = new List<StatusEffect>();
    
    // 기본 공격 데미지 계산
    public int CalculateBasicAttackDamage(BattleCharacter target)
    {
        // 기본 공식: 공격력 - (방어력 * 0.5), 최소 1
        int damage = Math.Max(1, Attack - (int)(target.Defense * 0.5));
        
        // 속성 상성 계산 (간단한 예시)
        double elementMultiplier = CalculateElementMultiplier(Element, target.Element);
        damage = (int)(damage * elementMultiplier);
        
        return damage;
    }
    
    // 속성 상성 계산 (간단한 예시)
    private double CalculateElementMultiplier(byte attackerElement, byte defenderElement)
    {
        // 예시: 1-불, 2-물, 3-바람, 4-땅
        if ((attackerElement == 1 && defenderElement == 4) ||
            (attackerElement == 2 && defenderElement == 1) ||
            (attackerElement == 3 && defenderElement == 2) ||
            (attackerElement == 4 && defenderElement == 3))
        {
            return 1.5; // 유리한 속성
        }
        else if ((attackerElement == 4 && defenderElement == 1) ||
                (attackerElement == 1 && defenderElement == 2) ||
                (attackerElement == 2 && defenderElement == 3) ||
                (attackerElement == 3 && defenderElement == 4))
        {
            return 0.75; // 불리한 속성
        }
        
        return 1.0; // 일반 속성
    }
    
    // 상태 효과 적용
    public void ApplyStatusEffect(StatusEffect effect)
    {
        // 이미 같은 효과가 있는지 확인
        var existingEffect = StatusEffects.FirstOrDefault(e => e.EffectType == effect.EffectType);
        
        if (existingEffect != null)
        {
            // 기존 효과 갱신
            existingEffect.Duration = Math.Max(existingEffect.Duration, effect.Duration);
            existingEffect.Value = effect.Value; // 보통 새 값으로 덮어씀
        }
        else
        {
            // 새 효과 추가
            StatusEffects.Add(effect);
        }
    }
    
    // 턴 시작 시 상태 효과 처리
    public List<StatusEffectResult> ProcessStatusEffects()
    {
        var results = new List<StatusEffectResult>();
        
        // 모든 상태 효과 처리
        foreach (var effect in StatusEffects.ToList())
        {
            // 지속 시간 감소
            effect.Duration--;
            
            // 효과 적용
            var result = ApplyEffectValue(effect);
            if (result != null)
            {
                results.Add(result);
            }
            
            // 지속 시간이 끝난 효과 제거
            if (effect.Duration <= 0)
            {
                StatusEffects.Remove(effect);
            }
        }
        
        return results;
    }
    
    // 상태 효과 값 적용
    private StatusEffectResult ApplyEffectValue(StatusEffect effect)
    {
        var result = new StatusEffectResult
        {
            EffectType = effect.EffectType,
            Value = 0
        };
        
        switch (effect.EffectType)
        {
            case StatusEffect.EFFECT_DOT: // 지속 데미지
                int dotDamage = effect.Value;
                CurrentHp = Math.Max(0, CurrentHp - dotDamage);
                DamageTaken += dotDamage;
                result.Value = dotDamage;
                break;
                
            case StatusEffect.EFFECT_HOT: // 지속 치유
                int hotHealing = effect.Value;
                int healingDone = Math.Min(hotHealing, MaxHp - CurrentHp);
                CurrentHp += healingDone;
                HealingDone += healingDone;
                result.Value = healingDone;
                break;
                
            case StatusEffect.EFFECT_ATK_UP: // 공격력 증가
            case StatusEffect.EFFECT_ATK_DOWN: // 공격력 감소
            case StatusEffect.EFFECT_DEF_UP: // 방어력 증가
            case StatusEffect.EFFECT_DEF_DOWN: // 방어력 감소
                // 이런 효과는 전투 계산 시에 적용됨
                return null;
                
            case StatusEffect.EFFECT_STUN: // 기절
                // 기절은 턴 스킵 처리에서 체크
                return null;
        }
        
        return result;
    }
}

// 상태 효과 클래스
public class StatusEffect
{
    public byte EffectType { get; set; }
    public int Value { get; set; }
    public int Duration { get; set; }
    public int SourceId { get; set; } // 효과 시전자 ID
    
    // 상태 효과 타입 상수
    public const byte EFFECT_DOT = 1; // 지속 데미지
    public const byte EFFECT_HOT = 2; // 지속 치유
    public const byte EFFECT_ATK_UP = 3; // 공격력 증가
    public const byte EFFECT_ATK_DOWN = 4; // 공격력 감소
    public const byte EFFECT_DEF_UP = 5; // 방어력 증가
    public const byte EFFECT_DEF_DOWN = 6; // 방어력 감소
    public const byte EFFECT_STUN = 7; // 기절
}

// 상태 효과 처리 결과
public class StatusEffectResult
{
    public byte EffectType { get; set; }
    public int Value { get; set; }
}

// 전투 액션 모델
public class BattleAction
{
    public byte ActionType { get; set; }
    public int SourceCharacterId { get; set; }
    public byte SourceTeam { get; set; }
    public byte SourcePosition { get; set; }
    public int? TargetCharacterId { get; set; }
    public byte? TargetTeam { get; set; }
    public byte? TargetPosition { get; set; }
    public int? SkillId { get; set; }
    public int Value { get; set; } // 데미지 또는 회복량
    public List<StatusEffect> AppliedEffects { get; set; } = new List<StatusEffect>();
    
    // 액션 타입 상수
    public const byte ACTION_BASIC_ATTACK = 1;
    public const byte ACTION_SKILL = 2;
    public const byte ACTION_STATUS_EFFECT = 3;
    public const byte ACTION_DEATH = 4;
}

// 스킬 모델
public class Skill
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public byte TargetType { get; set; } // 1-단일 적, 2-전체 적, 3-단일 아군, 4-전체 아군
    public byte EffectType { get; set; } // 1-데미지, 2-치유, 3-버프, 4-디버프
    public double DamageMultiplier { get; set; }
    public int Cooldown { get; set; }
    public int CurrentCooldown { get; set; }
    public List<StatusEffect> Effects { get; set; } = new List<StatusEffect>();
    
    // 타겟 타입 상수
    public const byte TARGET_SINGLE_ENEMY = 1;
    public const byte TARGET_ALL_ENEMIES = 2;
    public const byte TARGET_SINGLE_ALLY = 3;
    public const byte TARGET_ALL_ALLIES = 4;
    
    // 효과 타입 상수
    public const byte EFFECT_DAMAGE = 1;
    public const byte EFFECT_HEAL = 2;
    public const byte EFFECT_BUFF = 3;
    public const byte EFFECT_DEBUFF = 4;
}

// 전투 세션 정보
public class BattleSession
{
    public string SessionId { get; set; }
    public long PlayerId { get; set; }
    public byte BattleType { get; set; }
    public int? StageId { get; set; }
    public long? OpponentId { get; set; }
    public List<BattleCharacter> Characters { get; set; } = new List<BattleCharacter>();
    public int CurrentTurn { get; set; }
    public List<BattleAction> BattleLog { get; set; } = new List<BattleAction>();
    public DateTime StartTime { get; set; }
    public DateTime? EndTime { get; set; }
    public byte? Result { get; set; }
    
    // 팀별 캐릭터 목록 구하기
    public List<BattleCharacter> GetTeamCharacters(byte team)
    {
        return Characters.Where(c => c.Team == team && c.IsAlive).ToList();
    }
    
    // 전투 종료 여부 확인
    public bool IsFinished()
    {
        bool teamAllyAlive = Characters.Any(c => c.Team == BattleCharacter.TEAM_ALLY && c.IsAlive);
        bool teamEnemyAlive = Characters.Any(c => c.Team == BattleCharacter.TEAM_ENEMY && c.IsAlive);
        
        return !teamAllyAlive || !teamEnemyAlive;
    }
    
    // 전투 결과 결정
    public byte DetermineResult()
    {
        bool teamAllyAlive = Characters.Any(c => c.Team == BattleCharacter.TEAM_ALLY && c.IsAlive);
        bool teamEnemyAlive = Characters.Any(c => c.Team == BattleCharacter.TEAM_ENEMY && c.IsAlive);
        
        if (teamAllyAlive && !teamEnemyAlive)
        {
            return BattleRecord.RESULT_WIN;
        }
        else if (!teamAllyAlive && teamEnemyAlive)
        {
            return BattleRecord.RESULT_LOSE;
        }
        else
        {
            return BattleRecord.RESULT_DRAW;
        }
    }
}
```
  

## 12.3 전투 로직 설계
전투 시스템의 핵심 로직을 설계한다. 주요 구성 요소는 다음과 같다:

1. 전투 세션 초기화 및 관리
2. 턴 기반 전투 시뮬레이션
3. 데미지 계산 및 스킬 효과 처리
4. 전투 결과 판정 및 보상 계산

### 12.3.1 전투 데이터 액세스 레이어

```csharp
// Services/Battle/BattleRepository.cs
using MySqlConnector;
using SqlKata.Execution;
using SqlKata.Compilers;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

public class BattleRepository
{
    private readonly QueryFactory _queryFactory;
    
    public BattleRepository(string connectionString)
    {
        var connection = new MySqlConnection(connectionString);
        var compiler = new MySqlCompiler();
        _queryFactory = new QueryFactory(connection, compiler);
    }
    
    // 스테이지 정보 조회
    public async Task<BattleStage> GetStageByIdAsync(int stageId)
    {
        return await _queryFactory.Query("battle_stages")
            .Where("id", stageId)
            .FirstOrDefaultAsync<BattleStage>();
    }
    
    // 적 캐릭터 정보 조회
    public async Task<EnemyCharacter> GetEnemyCharacterByIdAsync(int enemyId)
    {
        return await _queryFactory.Query("enemy_characters")
            .Where("id", enemyId)
            .FirstOrDefaultAsync<EnemyCharacter>();
    }
    
    // 전투 기록 저장
    public async Task<long> CreateBattleRecordAsync(BattleRecord record)
    {
        return await _queryFactory.Query("battle_records").InsertGetIdAsync<long>(new {
            player_id = record.PlayerId,
            battle_type = record.BattleType,
            stage_id = record.StageId,
            opponent_id = record.OpponentId,
            result = record.Result,
            battle_time = record.BattleTime,
            total_damage = record.TotalDamage,
            clear_time = record.ClearTime,
            start_time = record.StartTime,
            end_time = record.EndTime,
            created_at = DateTime.UtcNow
        });
    }
    
    // 전투 상세 정보 저장
    public async Task<long> CreateBattleDetailAsync(BattleDetail detail)
    {
        return await _queryFactory.Query("battle_details").InsertGetIdAsync<long>(new {
            battle_record_id = detail.BattleRecordId,
            team_type = detail.TeamType,
            position = detail.Position,
            character_id = detail.CharacterId,
            character_level = detail.CharacterLevel,
            start_hp = detail.StartHp,
            end_hp = detail.EndHp,
            damage_dealt = detail.DamageDealt,
            damage_taken = detail.DamageTaken,
            healing_done = detail.HealingDone,
            skill_used = detail.SkillUsed,
            created_at = DateTime.UtcNow
        });
    }
    
    // 전투 이벤트 로그 저장
    public async Task<long> CreateBattleEventLogAsync(BattleEventLog log)
    {
        return await _queryFactory.Query("battle_event_logs").InsertGetIdAsync<long>(new {
            battle_record_id = log.BattleRecordId,
            event_type = log.EventType,
            turn = log.Turn,
            source_team = log.SourceTeam,
            source_position = log.SourcePosition,
            target_team = log.TargetTeam,
            target_position = log.TargetPosition,
            skill_id = log.SkillId,
            value = log.Value,
            effect_id = log.EffectId,
            effect_duration = log.EffectDuration,
            event_time = log.EventTime
        });
    }
    
    // 전투 이벤트 로그 일괄 저장
    public async Task CreateBattleEventLogsAsync(List<BattleEventLog> logs)
    {
        if (logs == null || logs.Count == 0)
            return;
            
        var dataToInsert = logs.Select(log => new {
            battle_record_id = log.BattleRecordId,
            event_type = log.EventType,
            turn = log.Turn,
            source_team = log.SourceTeam,
            source_position = log.SourcePosition,
            target_team = log.TargetTeam,
            target_position = log.TargetPosition,
            skill_id = log.SkillId,
            value = log.Value,
            effect_id = log.EffectId,
            effect_duration = log.EffectDuration,
            event_time = log.EventTime
        }).ToList();
        
        await _queryFactory.Query("battle_event_logs").InsertAsync(dataToInsert);
    }
    
    // 전투 보상 저장
    public async Task<long> CreateBattleRewardAsync(BattleReward reward)
    {
        return await _queryFactory.Query("battle_rewards").InsertGetIdAsync<long>(new {
            battle_record_id = reward.BattleRecordId,
            reward_type = reward.RewardType,
            item_id = reward.ItemId,
            item_type = reward.ItemType,
            quantity = reward.Quantity,
            is_claimed = reward.IsClaimed,
            claimed_at = reward.ClaimedAt,
            created_at = DateTime.UtcNow
        });
    }
    
    // 전투 보상 일괄 저장
    public async Task CreateBattleRewardsAsync(List<BattleReward> rewards)
    {
        if (rewards == null || rewards.Count == 0)
            return;
            
        var dataToInsert = rewards.Select(reward => new {
            battle_record_id = reward.BattleRecordId,
            reward_type = reward.RewardType,
            item_id = reward.ItemId,
            item_type = reward.ItemType,
            quantity = reward.Quantity,
            is_claimed = reward.IsClaimed,
            claimed_at = reward.ClaimedAt,
            created_at = DateTime.UtcNow
        }).ToList();
        
        await _queryFactory.Query("battle_rewards").InsertAsync(dataToInsert);
    }
    
    // 전투 기록 조회
    public async Task<BattleRecord> GetBattleRecordByIdAsync(long recordId)
    {
        return await _queryFactory.Query("battle_records")
            .Where("id", recordId)
            .FirstOrDefaultAsync<BattleRecord>();
    }
    
    // 전투 상세 정보 조회
    public async Task<List<BattleDetail>> GetBattleDetailsByRecordIdAsync(long recordId)
    {
        return await _queryFactory.Query("battle_details")
            .Where("battle_record_id", recordId)
            .GetAsync<BattleDetail>();
    }
    
    // 전투 이벤트 로그 조회
    public async Task<List<BattleEventLog>> GetBattleEventLogsByRecordIdAsync(long recordId)
    {
        return await _queryFactory.Query("battle_event_logs")
            .Where("battle_record_id", recordId)
            .OrderBy("turn")
            .OrderBy("event_time")
            .GetAsync<BattleEventLog>();
    }
    
    // 전투 보상 조회
    public async Task<List<BattleReward>> GetBattleRewardsByRecordIdAsync(long recordId)
    {
        return await _queryFactory.Query("battle_rewards")
            .Where("battle_record_id", recordId)
            .GetAsync<BattleReward>();
    }
    
    // 플레이어의 스테이지 첫 클리어 여부 확인
    public async Task<bool> IsFirstClearStageAsync(long playerId, int stageId)
    {
        var record = await _queryFactory.Query("battle_records")
            .Where("player_id", playerId)
            .Where("stage_id", stageId)
            .Where("result", BattleRecord.RESULT_WIN)
            .FirstOrDefaultAsync<BattleRecord>();
            
        return record == null;
    }
    
    // 특정 스테이지의 플레이어 클리어 기록 조회
    public async Task<List<BattleRecord>> GetPlayerStageClearRecordsAsync(long playerId, int stageId)
    {
        return await _queryFactory.Query("battle_records")
            .Where("player_id", playerId)
            .Where("stage_id", stageId)
            .Where("result", BattleRecord.RESULT_WIN)
            .OrderByDesc("created_at")
            .GetAsync<BattleRecord>();
    }
}
```

### 12.3.2 전투 시뮬레이션 서비스

```csharp
// Services/Battle/BattleSimulationService.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

public class BattleSimulationService
{
    private readonly Random _random = new Random();
    private readonly CharacterService _characterService; // 캐릭터 서비스 (캐릭터 정보 조회)
    private readonly BattleRepository _battleRepository; // 전투 저장소
    
    public BattleSimulationService(
        CharacterService characterService,
        BattleRepository battleRepository)
    {
        _characterService = characterService;
        _battleRepository = battleRepository;
    }
    
    // PvE 전투 세션 초기화
    public async Task<BattleSession> InitializePveBattleSessionAsync(long playerId, int stageId, List<BattleCharacterInput> playerTeam)
    {
        // 스테이지 정보 조회
        var stage = await _battleRepository.GetStageByIdAsync(stageId);
        if (stage == null)
        {
            throw new Exception($"Stage not found: {stageId}");
        }
        
        // 세션 초기화
        var session = new BattleSession
        {
            SessionId = Guid.NewGuid().ToString(),
            PlayerId = playerId,
            BattleType = BattleRecord.BATTLE_TYPE_PVE,
            StageId = stageId,
            StartTime = DateTime.UtcNow,
            CurrentTurn = 0
        };
        
        // 플레이어 팀 설정
        await SetupPlayerTeamAsync(session, playerTeam);
        
        // 적 팀 설정
        await SetupEnemyTeamAsync(session, stage);
        
        return session;
    }
    
    // 플레이어 팀 설정
    private async Task SetupPlayerTeamAsync(BattleSession session, List<BattleCharacterInput> playerTeam)
    {
        foreach (var charInput in playerTeam)
        {
            // 캐릭터 정보 조회
            var character = await _characterService.GetPlayerCharacterAsync(session.PlayerId, charInput.CharacterId);
            if (character == null)
            {
                throw new Exception($"Character not found: {charInput.CharacterId}");
            }
            
            // 전투 캐릭터 생성
            var battleChar = new BattleCharacter
            {
                Id = character.Id,
                Name = character.Name,
                Team = BattleDetail.TEAM_ALLY,
                Position = charInput.Position,
                Level = character.Level,
                MaxHp = character.Hp,
                CurrentHp = character.Hp,
                Attack = character.Attack,
                Defense = character.Defense,
                Speed = character.Speed,
                Element = character.Element,
                Skills = character.SkillIds // 캐릭터가 보유한 스킬 ID 목록
            };
            
            session.Characters.Add(battleChar);
        }
    }
    
    // 적 팀 설정
    private async Task SetupEnemyTeamAsync(BattleSession session, BattleStage stage)
    {
        foreach (var enemyPos in stage.EnemyTeamData)
        {
            // 적 캐릭터 정보 조회
            var enemyChar = await _battleRepository.GetEnemyCharacterByIdAsync(enemyPos.EnemyId);
            if (enemyChar == null)
            {
                throw new Exception($"Enemy character not found: {enemyPos.EnemyId}");
            }
            
            // 적 레벨 설정 (개별 레벨 또는 스테이지 기본 레벨)
            int enemyLevel = enemyPos.Level ?? stage.EnemyLevel;
            
            // 전투 캐릭터 생성
            var battleChar = new BattleCharacter
            {
                Id = enemyChar.Id,
                Name = enemyChar.Name,
                Team = BattleDetail.TEAM_ENEMY,
                Position = enemyPos.Position,
                Level = enemyLevel,
                MaxHp = ScaleEnemyStat(enemyChar.Hp, enemyLevel),
                CurrentHp = ScaleEnemyStat(enemyChar.Hp, enemyLevel),
                Attack = ScaleEnemyStat(enemyChar.Attack, enemyLevel),
                Defense = ScaleEnemyStat(enemyChar.Defense, enemyLevel),
                Speed = enemyChar.Speed,
                Element = enemyChar.Element,
                Skills = enemyChar.SkillsData
            };
            
            session.Characters.Add(battleChar);
        }
    }
    
    // 적 스탯 레벨 스케일링
    private int ScaleEnemyStat(int baseStat, int level)
    {
        // 레벨에 따른 스탯 스케일링 (간단한 예시)
        return (int)(baseStat * (1 + (level - 1) * 0.1));
    }
    
    // 전투 시뮬레이션 실행
    public async Task<BattleResult> SimulateBattleAsync(BattleSession session)
    {
        // 최대 턴 수 제한 (무한 루프 방지)
        const int MAX_TURNS = 30;
        
        // 전투 결과 객체 초기화
        var result = new BattleResult
        {
            Success = true,
            SessionId = session.SessionId,
            BattleActions = new List<BattleAction>()
        };
        
        // 턴 기반 전투 시뮬레이션
        while (!session.IsFinished() && session.CurrentTurn < MAX_TURNS)
        {
            // 새 턴 시작
            session.CurrentTurn++;
            
            // 속도에 따른 행동 순서 결정
            var actionOrder = DetermineActionOrder(session.Characters);
            
            // 각 캐릭터가 행동
            foreach (var character in actionOrder)
            {
                // 캐릭터가 죽었으면 스킵
                if (!character.IsAlive)
                    continue;
                    
                // 상태 효과 처리 (턴 시작 시)
                var statusResults = character.ProcessStatusEffects();
                foreach (var statusResult in statusResults)
                {
                    // 상태 효과로 인한 액션 기록
                    var statusAction = new BattleAction
                    {
                        ActionType = BattleAction.ACTION_STATUS_EFFECT,
                        SourceCharacterId = character.Id,
                        SourceTeam = character.Team,
                        SourcePosition = character.Position,
                        Value = statusResult.Value,
                        AppliedEffects = new List<StatusEffect>
                        {
                            new StatusEffect { EffectType = statusResult.EffectType, Value = statusResult.Value }
                        }
                    };
                    
                    session.BattleLog.Add(statusAction);
                    result.BattleActions.Add(statusAction);
                    
                    // 상태 효과로 사망했는지 확인
                    if (!character.IsAlive)
                    {
                        // 사망 액션 추가
                        var deathAction = new BattleAction
                        {
                            ActionType = BattleAction.ACTION_DEATH,
                            SourceCharacterId = character.Id,
                            SourceTeam = character.Team,
                            SourcePosition = character.Position
                        };
                        
                        session.BattleLog.Add(deathAction);
                        result.BattleActions.Add(deathAction);
                        break; // 이 캐릭터의 턴 종료
                    }
                }
                
                // 기절 등의 행동 불가 상태 확인
                if (character.StatusEffects.Any(e => e.EffectType == StatusEffect.EFFECT_STUN))
                {
                    continue; // 행동 스킵
                }
                
                // AI 또는 전략에 따라 액션 결정
                var action = DetermineAction(session, character);
                
                // 액션 실행
                ExecuteAction(session, action);
                
                // 액션 기록
                session.BattleLog.Add(action);
                result.BattleActions.Add(action);
                
                // 전투 종료 확인
                if (session.IsFinished())
                {
                    break;
                }
            }
        }
        
        // 전투 결과 결정
        session.Result = session.DetermineResult();
        session.EndTime = DateTime.UtcNow;
        
        // 결과 정보 설정
        result.Result = session.Result;
        result.TotalTurns = session.CurrentTurn;
        result.BattleTime = (int)(session.EndTime.Value - session.StartTime).TotalSeconds;
        
        return result;
    }
    
    // 액션 순서 결정 (속도 기반)
    private List<BattleCharacter> DetermineActionOrder(List<BattleCharacter> characters)
    {
        // 살아있는 캐릭터만 필터링하고 속도가 높은 순으로 정렬
        return characters
            .Where(c => c.IsAlive)
            .OrderByDescending(c => c.Speed)
            .ToList();
    }
    
    // 액션 결정 (AI 또는 전략)
    private BattleAction DetermineAction(BattleSession session, BattleCharacter character)
    {
        // 간단한 AI 로직
        // 적 팀이면 랜덤 타겟 선택, 아군이면 가장 체력이 낮은 적 선택
        List<BattleCharacter> targets;
        if (character.Team == BattleDetail.TEAM_ALLY)
        {
            // 아군인 경우 적군을 대상으로
            targets = session.GetTeamCharacters(BattleDetail.TEAM_ENEMY);
            if (targets.Count == 0)
                return null; // 대상이 없음
                
            // 가장 체력이 낮은 적 선택
            var target = targets.OrderBy(t => t.CurrentHp).First();
            
            // 스킬 사용 여부 결정 (간단한 예시: 30% 확률로 스킬 사용)
            if (character.Skills.Count > 0 && _random.NextDouble() < 0.3)
            {
                // 스킬 선택 (간단한 예시: 첫 번째 스킬)
                int skillId = character.Skills[0];
                
                // 스킬 액션 반환
                return new BattleAction
                {
                    ActionType = BattleAction.ACTION_SKILL,
                    SourceCharacterId = character.Id,
                    SourceTeam = character.Team,
                    SourcePosition = character.Position,
                    TargetCharacterId = target.Id,
                    TargetTeam = target.Team,
                    TargetPosition = target.Position,
                    SkillId = skillId,
                    Value = CalculateSkillDamage(character, target, skillId)
                };
            }
            else
            {
                // 기본 공격 액션 반환
                return new BattleAction
                {
                    ActionType = BattleAction.ACTION_BASIC_ATTACK,
                    SourceCharacterId = character.Id,
                    SourceTeam = character.Team,
                    SourcePosition = character.Position,
                    TargetCharacterId = target.Id,
                    TargetTeam = target.Team,
                    TargetPosition = target.Position,
                    Value = character.CalculateBasicAttackDamage(target)
                };
            }
        }
        else
        {
            // 적군인 경우 아군을 대상으로
            targets = session.GetTeamCharacters(BattleDetail.TEAM_ALLY);
            if (targets.Count == 0)
                return null; // 대상이 없음
                
            // 랜덤 대상 선택
            var target = targets[_random.Next(targets.Count)];
            
            // 스킬 사용 여부 결정 (간단한 예시: 20% 확률로 스킬 사용)
            if (character.Skills.Count > 0 && _random.NextDouble() < 0.2)
            {
                // 스킬 선택 (간단한 예시: 첫 번째 스킬)
                int skillId = character.Skills[0];
                
                // 스킬 액션 반환
                return new BattleAction
                {
                    ActionType = BattleAction.ACTION_SKILL,
                    SourceCharacterId = character.Id,
                    SourceTeam = character.Team,
                    SourcePosition = character.Position,
                    TargetCharacterId = target.Id,
                    TargetTeam = target.Team,
                    TargetPosition = target.Position,
                    SkillId = skillId,
                    Value = CalculateSkillDamage(character, target, skillId)
                };
            }
            else
            {
                // 기본 공격 액션 반환
                return new BattleAction
                {
                    ActionType = BattleAction.ACTION_BASIC_ATTACK,
                    SourceCharacterId = character.Id,
                    SourceTeam = character.Team,
                    SourcePosition = character.Position,
                    TargetCharacterId = target.Id,
                    TargetTeam = target.Team,
                    TargetPosition = target.Position,
                    Value = character.CalculateBasicAttackDamage(target)
                };
            }
        }
    }
    
    // 스킬 데미지 계산 (간단한 예시)
    private int CalculateSkillDamage(BattleCharacter source, BattleCharacter target, int skillId)
    {
        // 실제로는 스킬 데이터베이스에서 스킬 정보를 조회해야 함
        // 여기서는 간단한 예시로 스킬 ID에 따라 배율 결정
        double multiplier = 1.5 + (skillId % 10) * 0.1; // 예시: 스킬 ID에 따라 1.5~2.4 배율
        
        // 기본 데미지 계산
        int baseDamage = source.CalculateBasicAttackDamage(target);
        
        // 스킬 데미지 = 기본 데미지 * 배율
        return (int)(baseDamage * multiplier);
    }
    
    // 액션 실행
    private void ExecuteAction(BattleSession session, BattleAction action)
    {
        if (action == null)
            return;
            
        // 소스 캐릭터 찾기
        var source = session.Characters.FirstOrDefault(c => c.Id == action.SourceCharacterId);
        if (source == null || !source.IsAlive)
            return;
            
        // 타겟 캐릭터 찾기 (있는 경우)
        BattleCharacter target = null;
        if (action.TargetCharacterId.HasValue)
        {
            target = session.Characters.FirstOrDefault(c => c.Id == action.TargetCharacterId.Value);
            if (target == null || !target.IsAlive)
                return;
        }
        
        // 액션 타입에 따른 처리
        switch (action.ActionType)
        {
            case BattleAction.ACTION_BASIC_ATTACK:
                // 기본 공격 처리
                ExecuteBasicAttack(source, target, action);
                break;
                
            case BattleAction.ACTION_SKILL:
                // 스킬 처리
                ExecuteSkill(source, target, action);
                break;
        }
    }
    
    // 기본 공격 실행
    private void ExecuteBasicAttack(BattleCharacter source, BattleCharacter target, BattleAction action)
    {
        // 데미지 적용
        target.CurrentHp = Math.Max(0, target.CurrentHp - action.Value);
        
        // 통계 업데이트
        source.DamageDealt += action.Value;
        target.DamageTaken += action.Value;
        
        // 사망 확인
        if (target.CurrentHp <= 0)
        {
            action.AppliedEffects.Add(new StatusEffect
            {
                EffectType = StatusEffect.EFFECT_DEATH,
                SourceId = source.Id
            });
        }
    }
    
    // 스킬 실행
    private void ExecuteSkill(BattleCharacter source, BattleCharacter target, BattleAction action)
    {
        // 스킬 사용 횟수 기록
        if (action.SkillId.HasValue)
        {
            if (!source.SkillUseCount.ContainsKey(action.SkillId.Value))
            {
                source.SkillUseCount[action.SkillId.Value] = 0;
            }
            source.SkillUseCount[action.SkillId.Value]++;
        }
        
        // 데미지 액션인 경우
        if (action.Value > 0)
        {
            target.CurrentHp = Math.Max(0, target.CurrentHp - action.Value);
            
            // 통계 업데이트
            source.DamageDealt += action.Value;
            target.DamageTaken += action.Value;
            
            // 사망 확인
            if (target.CurrentHp <= 0)
            {
                action.AppliedEffects.Add(new StatusEffect
                {
                    EffectType = StatusEffect.EFFECT_DEATH,
                    SourceId = source.Id
                });
            }
        }
        
        // 스킬 효과 적용 (상태 효과 등)
        // 실제로는 스킬 데이터베이스에서 효과 정보를 조회해야 함
        // 여기서는 간단한 예시로 스킬 ID에 따라 다른 효과 적용
        if (action.SkillId.HasValue)
        {
            var skillId = action.SkillId.Value;
            
            // 간단한 예시: 스킬 ID에 따라 다른 효과 적용
            if (skillId % 5 == 0) // DoT (지속 데미지)
            {
                var effect = new StatusEffect
                {
                    EffectType = StatusEffect.EFFECT_DOT,
                    Value = source.Attack / 5,
                    Duration = 3,
                    SourceId = source.Id
                };
                
                target.ApplyStatusEffect(effect);
                action.AppliedEffects.Add(effect);
            }
            else if (skillId % 5 == 1) // 공격력 감소
            {
                var effect = new StatusEffect
                {
                    EffectType = StatusEffect.EFFECT_ATK_DOWN,
                    Value = 20, // 20% 감소
                    Duration = 2,
                    SourceId = source.Id
                };
                
                target.ApplyStatusEffect(effect);
                action.AppliedEffects.Add(effect);
            }
            else if (skillId % 5 == 2) // 방어력 감소
            {
                var effect = new StatusEffect
                {
                    EffectType = StatusEffect.EFFECT_DEF_DOWN,
                    Value = 20, // 20% 감소
                    Duration = 2,
                    SourceId = source.Id
                };
                
                target.ApplyStatusEffect(effect);
                action.AppliedEffects.Add(effect);
            }
            else if (skillId % 5 == 3) // 기절
            {
                var effect = new StatusEffect
                {
                    EffectType = StatusEffect.EFFECT_STUN,
                    Duration = 1,
                    SourceId = source.Id
                };
                
                target.ApplyStatusEffect(effect);
                action.AppliedEffects.Add(effect);
            }
        }
    }
    
    // 전투 결과 저장
    public async Task<long> SaveBattleResultAsync(BattleSession session, BattleResult result)
    {
        // 전투 기록 생성
        var record = new BattleRecord
        {
            PlayerId = session.PlayerId,
            BattleType = session.BattleType,
            StageId = session.StageId,
            OpponentId = session.OpponentId,
            Result = session.Result.Value,
            BattleTime = result.BattleTime,
            TotalDamage = session.Characters
                .Where(c => c.Team == BattleDetail.TEAM_ALLY)
                .Sum(c => c.DamageDealt),
            StartTime = session.StartTime,
            EndTime = session.EndTime.Value,
            ClearTime = DateTime.UtcNow
        };
        
        // DB에 전투 기록 저장
        long recordId = await _battleRepository.CreateBattleRecordAsync(record);
        
        // 전투 상세 정보 저장
        foreach (var character in session.Characters)
        {
            var detail = new BattleDetail
            {
                BattleRecordId = recordId,
                TeamType = character.Team,
                Position = character.Position,
                CharacterId = character.Id,
                CharacterLevel = character.Level,
                StartHp = character.MaxHp,
                EndHp = character.CurrentHp,
                DamageDealt = character.DamageDealt,
                DamageTaken = character.DamageTaken,
                HealingDone = character.HealingDone,
                SkillUsedDict = character.SkillUseCount
            };
            
            await _battleRepository.CreateBattleDetailAsync(detail);
        }
        
        // 전투 이벤트 로그 저장
        var eventLogs = new List<BattleEventLog>();
        int logIndex = 0;
        
        foreach (var action in session.BattleLog)
        {
            var log = new BattleEventLog
            {
                BattleRecordId = recordId,
                EventType = action.ActionType,
                Turn = logIndex / 5 + 1, // 간단한 예시: 5개 액션마다 턴 증가
                SourceTeam = action.SourceTeam,
                SourcePosition = action.SourcePosition,
                TargetTeam = action.TargetTeam ?? 0,
                TargetPosition = action.TargetPosition ?? 0,
                SkillId = action.SkillId,
                Value = action.Value,
                EventTime = DateTime.UtcNow.AddMilliseconds(logIndex * 100) // 로그 간 시간차 설정
            };
            
            eventLogs.Add(log);
            logIndex++;
            
            // 상태 효과가 있는 경우 추가 로그 생성
            foreach (var effect in action.AppliedEffects)
            {
                var effectLog = new BattleEventLog
                {
                    BattleRecordId = recordId,
                    EventType = BattleEventLog.EVENT_STATUS,
                    Turn = logIndex / 5 + 1,
                    SourceTeam = action.SourceTeam,
                    SourcePosition = action.SourcePosition,
                    TargetTeam = action.TargetTeam ?? 0,
                    TargetPosition = action.TargetPosition ?? 0,
                    EffectId = (int)effect.EffectType,
                    EffectDuration = effect.Duration,
                    Value = effect.Value,
                    EventTime = DateTime.UtcNow.AddMilliseconds(logIndex * 100)
                };
                
                eventLogs.Add(effectLog);
                logIndex++;
            }
        }
        
        // 이벤트 로그 일괄 저장
        await _battleRepository.CreateBattleEventLogsAsync(eventLogs);
        
        return recordId;
    }
}

// 입력 모델
public class BattleCharacterInput
{
    public long CharacterId { get; set; }
    public byte Position { get; set; }
}

// 전투 결과 모델
public class BattleResult
{
    public bool Success { get; set; }
    public string SessionId { get; set; }
    public byte? Result { get; set; }
    public int TotalTurns { get; set; }
    public int BattleTime { get; set; }
    public List<BattleAction> BattleActions { get; set; }
}
```
  

## 12.4 전투 결과 계산 API
이제 앞서 설계한 전투 로직을 API로 노출하기 위한 컨트롤러와 서비스 계층을 구현한다.

### 12.4.1 전투 서비스 구현

```csharp
// Services/Battle/BattleService.cs
using System;
using System.Collections.Generic;
using System.Threading.Tasks;

public class BattleService
{
    private readonly BattleSimulationService _simulationService;
    private readonly BattleRepository _battleRepository;
    private readonly BattleRewardService _rewardService;
    private readonly BattleCacheService _cacheService;
    
    public BattleService(
        BattleSimulationService simulationService,
        BattleRepository battleRepository,
        BattleRewardService rewardService,
        BattleCacheService cacheService)
    {
        _simulationService = simulationService;
        _battleRepository = battleRepository;
        _rewardService = rewardService;
        _cacheService = cacheService;
    }
    
    // PvE 전투 시작
    public async Task<BattlePveResult> StartPveBattleAsync(long playerId, int stageId, List<BattleCharacterInput> playerTeam)
    {
        try
        {
            // 전투 세션 초기화
            var session = await _simulationService.InitializePveBattleSessionAsync(playerId, stageId, playerTeam);
            
            // 전투 시뮬레이션 실행
            var battleResult = await _simulationService.SimulateBattleAsync(session);
            
            // 전투 결과가 성공인 경우만 저장
            if (battleResult.Success)
            {
                // 전투 결과 저장
                long battleRecordId = await _simulationService.SaveBattleResultAsync(session, battleResult);
                
                // 전투 보상 계산 및 지급
                var rewards = await _rewardService.CalculateAndGrantPveRewardsAsync(
                    playerId, 
                    stageId, 
                    battleRecordId, 
                    battleResult.Result == BattleRecord.RESULT_WIN);
                
                // 결과 반환
                return new BattlePveResult
                {
                    Success = true,
                    BattleRecordId = battleRecordId,
                    Result = battleResult.Result,
                    Actions = battleResult.BattleActions,
                    Rewards = rewards,
                    TotalTurns = battleResult.TotalTurns,
                    BattleTime = battleResult.BattleTime
                };
            }
            else
            {
                return new BattlePveResult
                {
                    Success = false,
                    ErrorCode = 500,
                    ErrorMessage = "Battle simulation failed"
                };
            }
        }
        catch (Exception ex)
        {
            return new BattlePveResult
            {
                Success = false,
                ErrorCode = 500,
                ErrorMessage = ex.Message
            };
        }
    }
    
    // 전투 로그 조회
    public async Task<BattleLogResult> GetBattleLogAsync(long battleRecordId)
    {
        try
        {
            // 캐시에서 먼저 조회 시도
            var cachedLog = await _cacheService.GetBattleLogAsync(battleRecordId);
            if (cachedLog != null)
            {
                return cachedLog;
            }
            
            // 전투 기록 조회
            var record = await _battleRepository.GetBattleRecordByIdAsync(battleRecordId);
            if (record == null)
            {
                return new BattleLogResult
                {
                    Success = false,
                    ErrorCode = 404,
                    ErrorMessage = "Battle record not found"
                };
            }
            
            // 전투 상세 정보 조회
            var details = await _battleRepository.GetBattleDetailsByRecordIdAsync(battleRecordId);
            
            // 전투 이벤트 로그 조회
            var eventLogs = await _battleRepository.GetBattleEventLogsByRecordIdAsync(battleRecordId);
            
            // 결과 변환
            var actions = ConvertEventLogsToActions(eventLogs);
            
            // 결과 반환
            var result = new BattleLogResult
            {
                Success = true,
                BattleRecordId = battleRecordId,
                BattleType = record.BattleType,
                StageId = record.StageId,
                OpponentId = record.OpponentId,
                Result = record.Result,
                StartTime = record.StartTime,
                EndTime = record.EndTime,
                BattleTime = record.BattleTime,
                TotalDamage = record.TotalDamage,
                CharacterDetails = details,
                Actions = actions
            };
            
            // 캐시에 저장
            await _cacheService.SetBattleLogAsync(battleRecordId, result);
            
            return result;
        }
        catch (Exception ex)
        {
            return new BattleLogResult
            {
                Success = false,
                ErrorCode = 500,
                ErrorMessage = ex.Message
            };
        }
    }
    
    // 전투 보상 조회
    public async Task<BattleRewardsResult> GetBattleRewardsAsync(long battleRecordId)
    {
        try
        {
            // 전투 기록 조회
            var record = await _battleRepository.GetBattleRecordByIdAsync(battleRecordId);
            if (record == null)
            {
                return new BattleRewardsResult
                {
                    Success = false,
                    ErrorCode = 404,
                    ErrorMessage = "Battle record not found"
                };
            }
            
            // 전투 보상 조회
            var rewards = await _battleRepository.GetBattleRewardsByRecordIdAsync(battleRecordId);
            
            // 결과 반환
            return new BattleRewardsResult
            {
                Success = true,
                BattleRecordId = battleRecordId,
                Rewards = rewards
            };
        }
        catch (Exception ex)
        {
            return new BattleRewardsResult
            {
                Success = false,
                ErrorCode = 500,
                ErrorMessage = ex.Message
            };
        }
    }
    
    // 이벤트 로그를 액션으로 변환
    private List<BattleAction> ConvertEventLogsToActions(List<BattleEventLog> eventLogs)
    {
        var actions = new List<BattleAction>();
        
        foreach (var log in eventLogs)
        {
            // 상태 효과 이벤트는 별도 처리
            if (log.EventType == BattleEventLog.EVENT_STATUS)
                continue;
                
            // 기본 액션 생성
            var action = new BattleAction
            {
                ActionType = log.EventType,
                SourceTeam = log.SourceTeam,
                SourcePosition = log.SourcePosition,
                TargetTeam = log.TargetTeam,
                TargetPosition = log.TargetPosition,
                SkillId = log.SkillId,
                Value = log.Value ?? 0,
                AppliedEffects = new List<StatusEffect>()
            };
            
            // 관련된 상태 효과 이벤트 찾기
            var relatedEffects = eventLogs.Where(e => 
                e.EventType == BattleEventLog.EVENT_STATUS &&
                e.SourceTeam == log.SourceTeam &&
                e.SourcePosition == log.SourcePosition &&
                e.TargetTeam == log.TargetTeam &&
                e.TargetPosition == log.TargetPosition &&
                Math.Abs((e.EventTime - log.EventTime).TotalMilliseconds) < 500 // 같은 시점의 이벤트
            ).ToList();
            
            // 상태 효과 추가
            foreach (var effect in relatedEffects)
            {
                action.AppliedEffects.Add(new StatusEffect
                {
                    EffectType = (byte)(effect.EffectId ?? 0),
                    Value = effect.Value ?? 0,
                    Duration = effect.EffectDuration ?? 0
                });
            }
            
            actions.Add(action);
        }
        
        return actions;
    }
}

// 전투 결과 모델
public class BattlePveResult
{
    public bool Success { get; set; }
    public int ErrorCode { get; set; }
    public string ErrorMessage { get; set; }
    public long BattleRecordId { get; set; }
    public byte? Result { get; set; }
    public List<BattleAction> Actions { get; set; }
    public List<BattleRewardInfo> Rewards { get; set; }
    public int TotalTurns { get; set; }
    public int BattleTime { get; set; }
}

// 전투 로그 결과 모델
public class BattleLogResult
{
    public bool Success { get; set; }
    public int ErrorCode { get; set; }
    public string ErrorMessage { get; set; }
    public long BattleRecordId { get; set; }
    public byte BattleType { get; set; }
    public int? StageId { get; set; }
    public long? OpponentId { get; set; }
    public byte Result { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public int BattleTime { get; set; }
    public int TotalDamage { get; set; }
    public List<BattleDetail> CharacterDetails { get; set; }
    public List<BattleAction> Actions { get; set; }
}

// 전투 보상 결과 모델
public class BattleRewardsResult
{
    public bool Success { get; set; }
    public int ErrorCode { get; set; }
    public string ErrorMessage { get; set; }
    public long BattleRecordId { get; set; }
    public List<BattleReward> Rewards { get; set; }
}

// 전투 보상 정보 모델
public class BattleRewardInfo
{
    public byte RewardType { get; set; }
    public int? ItemId { get; set; }
    public byte? ItemType { get; set; }
    public int Quantity { get; set; }
    public string ItemName { get; set; }
}
```

### 12.4.2 Web API 컨트롤러 구현

```csharp
// Controllers/BattleController.cs
using Microsoft.AspNetCore.Mvc;
using System;
using System.Threading.Tasks;

[ApiController]
[Route("api/battle")]
public class BattleController : ControllerBase
{
    private readonly BattleService _battleService;
    
    public BattleController(BattleService battleService)
    {
        _battleService = battleService;
    }
    
    // PvE 전투 시작
    [HttpPost("pve/start")]
    public async Task<BattlePveResult> StartPveBattle([FromBody] StartPveBattleRequest request)
    {
        return await _battleService.StartPveBattleAsync(
            request.PlayerId,
            request.StageId,
            request.PlayerTeam);
    }
    
    // 전투 로그 조회
    [HttpPost("log")]
    public async Task<BattleLogResult> GetBattleLog([FromBody] BattleLogRequest request)
    {
        return await _battleService.GetBattleLogAsync(request.BattleRecordId);
    }
    
    // 전투 보상 조회
    [HttpPost("rewards")]
    public async Task<BattleRewardsResult> GetBattleRewards([FromBody] BattleRewardsRequest request)
    {
        return await _battleService.GetBattleRewardsAsync(request.BattleRecordId);
    }
}

// 요청 모델
public class StartPveBattleRequest
{
    public long PlayerId { get; set; }
    public int StageId { get; set; }
    public List<BattleCharacterInput> PlayerTeam { get; set; }
}

public class BattleLogRequest
{
    public long BattleRecordId { get; set; }
}

public class BattleRewardsRequest
{
    public long BattleRecordId { get; set; }
}
```

## 12.5 전투 로그 및 리워드 시스템

### 12.5.1 전투 보상 서비스 구현

```csharp
// Services/Battle/BattleRewardService.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

public class BattleRewardService
{
    private readonly BattleRepository _battleRepository;
    private readonly InventoryService _inventoryService; // 인벤토리 서비스 (아이템 지급)
    private readonly CharacterService _characterService; // 캐릭터 서비스 (경험치 지급)
    private readonly CurrencyService _currencyService;   // 재화 서비스 (골드 등 지급)
    private readonly Random _random = new Random();
    
    public BattleRewardService(
        BattleRepository battleRepository,
        InventoryService inventoryService,
        CharacterService characterService,
        CurrencyService currencyService)
    {
        _battleRepository = battleRepository;
        _inventoryService = inventoryService;
        _characterService = characterService;
        _currencyService = currencyService;
    }
    
    // PvE 전투 보상 계산 및 지급
    public async Task<List<BattleRewardInfo>> CalculateAndGrantPveRewardsAsync(
        long playerId, 
        int stageId, 
        long battleRecordId, 
        bool isVictory)
    {
        // 스테이지 정보 조회
        var stage = await _battleRepository.GetStageByIdAsync(stageId);
        if (stage == null)
        {
            throw new Exception($"Stage not found: {stageId}");
        }
        
        var rewards = new List<BattleRewardInfo>();
        var dbRewards = new List<BattleReward>();
        
        // 승리한 경우만 보상 지급
        if (isVictory)
        {
            // 첫 클리어 여부 확인
            bool isFirstClear = await _battleRepository.IsFirstClearStageAsync(playerId, stageId);
            
            // 경험치 보상
            int expReward = stage.ExpReward;
            await _characterService.AddExpToTeamAsync(playerId, expReward);
            
            // 경험치 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_EXPERIENCE,
                Quantity = expReward,
                ItemName = "Experience"
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_EXPERIENCE,
                Quantity = expReward,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
            
            // 골드 보상
            int goldReward = stage.GoldReward;
            await _currencyService.AddCurrencyAsync(playerId, "gold", goldReward);
            
            // 골드 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                ItemName = "Gold"
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
            
            // 일반 아이템 보상
            foreach (var rewardData in stage.NormalRewardsData)
            {
                // 확률 기반 드롭 처리
                if (_random.NextDouble() <= rewardData.DropRate)
                {
                    // 아이템 종류에 따른 처리
                    if (rewardData.RewardType == BattleReward.REWARD_ITEM)
                    {
                        // 아이템 지급
                        string itemCode = $"item_{rewardData.ItemId}";
                        var item = await _inventoryService.AddItemToInventoryAsync(
                            playerId, 
                            itemCode, 
                            rewardData.Quantity);
                            
                        // 아이템 보상 기록
                        rewards.Add(new BattleRewardInfo
                        {
                            RewardType = BattleReward.REWARD_ITEM,
                            ItemId = rewardData.ItemId,
                            ItemType = (byte)1, // 아이템 타입 (예시)
                            Quantity = rewardData.Quantity,
                            ItemName = item.Item.Name
                        });
                        
                        dbRewards.Add(new BattleReward
                        {
                            BattleRecordId = battleRecordId,
                            RewardType = BattleReward.REWARD_ITEM,
                            ItemId = rewardData.ItemId,
                            ItemType = (byte)1,
                            Quantity = rewardData.Quantity,
                            IsClaimed = true,
                            ClaimedAt = DateTime.UtcNow
                        });
                    }
                    else if (rewardData.RewardType == BattleReward.REWARD_CHARACTER)
                    {
                        // 캐릭터 지급 (매우 드문 경우)
                        // 이미 보유한 캐릭터인지 확인
                        bool hasCharacter = await _characterService.HasCharacterAsync(playerId, rewardData.ItemId);
                        
                        if (!hasCharacter)
                        {
                            // 새 캐릭터 획득
                            await _characterService.AcquireCharacterAsync(playerId, rewardData.ItemId);
                            
                            // 캐릭터 정보 조회
                            var character = await _characterService.GetCharacterMasterByIdAsync(rewardData.ItemId);
                            
                            // 캐릭터 보상 기록
                            rewards.Add(new BattleRewardInfo
                            {
                                RewardType = BattleReward.REWARD_CHARACTER,
                                ItemId = rewardData.ItemId,
                                Quantity = 1,
                                ItemName = character.Name
                            });
                            
                            dbRewards.Add(new BattleReward
                            {
                                BattleRecordId = battleRecordId,
                                RewardType = BattleReward.REWARD_CHARACTER,
                                ItemId = rewardData.ItemId,
                                Quantity = 1,
                                IsClaimed = true,
                                ClaimedAt = DateTime.UtcNow
                            });
                        }
                        else
                        {
                            // 중복 캐릭터 처리 (조각으로 변환)
                            string fragmentCode = $"character_fragment_{rewardData.ItemId}";
                            var item = await _inventoryService.AddItemToInventoryAsync(
                                playerId, 
                                fragmentCode, 
                                10); // 중복 캐릭터는 10개 조각으로 변환 (예시)
                                
                            // 조각 보상 기록
                            rewards.Add(new BattleRewardInfo
                            {
                                RewardType = BattleReward.REWARD_ITEM,
                                ItemId = rewardData.ItemId,
                                ItemType = (byte)3, // 캐릭터 조각 타입 (예시)
                                Quantity = 10,
                                ItemName = $"{item.Item.Name} Fragments"
                            });
                            
                            dbRewards.Add(new BattleReward
                            {
                                BattleRecordId = battleRecordId,
                                RewardType = BattleReward.REWARD_ITEM,
                                ItemId = rewardData.ItemId,
                                ItemType = (byte)3,
                                Quantity = 10,
                                IsClaimed = true,
                                ClaimedAt = DateTime.UtcNow
                            });
                        }
                    }
                }
            }
            
            // 첫 클리어 보상 (한 번만 지급)
            if (isFirstClear && stage.FirstClearRewardsData != null && stage.FirstClearRewardsData.Count > 0)
            {
                foreach (var rewardData in stage.FirstClearRewardsData)
                {
                    // 첫 클리어 보상은 확률 체크 없이 100% 지급
                    if (rewardData.RewardType == BattleReward.REWARD_ITEM)
                    {
                        // 아이템 지급
                        string itemCode = $"item_{rewardData.ItemId}";
                        var item = await _inventoryService.AddItemToInventoryAsync(
                            playerId, 
                            itemCode, 
                            rewardData.Quantity);
                            
                        // 아이템 보상 기록
                        rewards.Add(new BattleRewardInfo
                        {
                            RewardType = BattleReward.REWARD_ITEM,
                            ItemId = rewardData.ItemId,
                            ItemType = (byte)1, // 아이템 타입
                            Quantity = rewardData.Quantity,
                            ItemName = item.Item.Name
                        });
                        
                        dbRewards.Add(new BattleReward
                        {
                            BattleRecordId = battleRecordId,
                            RewardType = BattleReward.REWARD_ITEM,
                            ItemId = rewardData.ItemId,
                            ItemType = (byte)1,
                            Quantity = rewardData.Quantity,
                            IsClaimed = true,
                            ClaimedAt = DateTime.UtcNow
                        });
                    }
                    else if (rewardData.RewardType == BattleReward.REWARD_CHARACTER)
                    {
                        // 캐릭터 지급
                        bool hasCharacter = await _characterService.HasCharacterAsync(playerId, rewardData.ItemId);
                        
                        if (!hasCharacter)
                        {
                            // 새 캐릭터 획득
                            await _characterService.AcquireCharacterAsync(playerId, rewardData.ItemId);
                            
                            // 캐릭터 정보 조회
                            var character = await _characterService.GetCharacterMasterByIdAsync(rewardData.ItemId);
                            
                            // 캐릭터 보상 기록
                            rewards.Add(new BattleRewardInfo
                            {
                                RewardType = BattleReward.REWARD_CHARACTER,
                                ItemId = rewardData.ItemId,
                                Quantity = 1,
                                ItemName = character.Name
                            });
                            
                            dbRewards.Add(new BattleReward
                            {
                                BattleRecordId = battleRecordId,
                                RewardType = BattleReward.REWARD_CHARACTER,
                                ItemId = rewardData.ItemId,
                                Quantity = 1,
                                IsClaimed = true,
                                ClaimedAt = DateTime.UtcNow
                            });
                        }
                        else
                        {
                            // 중복 캐릭터 처리 (더 많은 조각으로 변환)
                            string fragmentCode = $"character_fragment_{rewardData.ItemId}";
                            var item = await _inventoryService.AddItemToInventoryAsync(
                                playerId, 
                                fragmentCode, 
                                20); // 첫 클리어 중복 캐릭터는 20개 조각으로 변환 (일반보다 더 많이)
                                
                            // 조각 보상 기록
                            rewards.Add(new BattleRewardInfo
                            {
                                RewardType = BattleReward.REWARD_ITEM,
                                ItemId = rewardData.ItemId,
                                ItemType = (byte)3, // 캐릭터 조각 타입
                                Quantity = 20,
                                ItemName = $"{item.Item.Name} Fragments"
                            });
                            
                            dbRewards.Add(new BattleReward
                            {
                                BattleRecordId = battleRecordId,
                                RewardType = BattleReward.REWARD_ITEM,
                                ItemId = rewardData.ItemId,
                                ItemType = (byte)3,
                                Quantity = 20,
                                IsClaimed = true,
                                ClaimedAt = DateTime.UtcNow
                            });
                        }
                    }
                }
            }
        }
        
        // 보상 DB에 저장
        await _battleRepository.CreateBattleRewardsAsync(dbRewards);
        
        return rewards;
    }
    
    // PvP 전투 보상 계산 및 지급 (예시로 포함)
    public async Task<List<BattleRewardInfo>> CalculateAndGrantPvpRewardsAsync(
        long playerId, 
        long battleRecordId, 
        int rankPoints, 
        bool isVictory)
    {
        var rewards = new List<BattleRewardInfo>();
        var dbRewards = new List<BattleReward>();
        
        // 승리/패배에 따른 보상 차등 지급
        if (isVictory)
        {
            // 랭크 포인트 보상
            int pointReward = 20 + (int)(rankPoints * 0.05);
            await _currencyService.AddCurrencyAsync(playerId, "rank_point", pointReward);
            
            // 랭크 포인트 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_GOLD, // 여기서는 gold 타입을 재활용 (실제로는 별도 타입 정의 필요)
                Quantity = pointReward,
                ItemName = "Rank Points"
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = pointReward,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
            
            // 승리 보상 (골드)
            int goldReward = 500;
            await _currencyService.AddCurrencyAsync(playerId, "gold", goldReward);
            
            // 골드 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                ItemName = "Gold"
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
            
            // 기타 보상 아이템 (승리 보상용 토큰 등)
            string pvpTokenCode = "item_pvp_token";
            var pvpToken = await _inventoryService.AddItemToInventoryAsync(
                playerId, 
                pvpTokenCode, 
                3); // 승리 시 3개 지급
                
            // 토큰 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_ITEM,
                ItemId = pvpToken.ItemId,
                ItemType = (byte)1,
                Quantity = 3,
                ItemName = pvpToken.Item.Name
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_ITEM,
                ItemId = pvpToken.ItemId,
                ItemType = (byte)1,
                Quantity = 3,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
        }
        else
        {
            // 패배 시에도 소량 보상 지급
            
            // 랭크 포인트 차감 (최소값 0)
            int pointLoss = Math.Min(10, rankPoints);
            if (pointLoss > 0)
            {
                await _currencyService.ConsumeCurrencyAsync(playerId, "rank_point", pointLoss);
                
                // 랭크 포인트 차감 기록
                rewards.Add(new BattleRewardInfo
                {
                    RewardType = BattleReward.REWARD_GOLD,
                    Quantity = -pointLoss,
                    ItemName = "Rank Points"
                });
                
                dbRewards.Add(new BattleReward
                {
                    BattleRecordId = battleRecordId,
                    RewardType = BattleReward.REWARD_GOLD,
                    Quantity = -pointLoss,
                    IsClaimed = true,
                    ClaimedAt = DateTime.UtcNow
                });
            }
            
            // 패배 보상 (소량의 골드)
            int goldReward = 100;
            await _currencyService.AddCurrencyAsync(playerId, "gold", goldReward);
            
            // 골드 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                ItemName = "Gold"
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_GOLD,
                Quantity = goldReward,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
            
            // 기타 보상 아이템 (패배 보상용 토큰 등, 승리보다 적게)
            string pvpTokenCode = "item_pvp_token";
            var pvpToken = await _inventoryService.AddItemToInventoryAsync(
                playerId, 
                pvpTokenCode, 
                1); // 패배 시 1개 지급
                
            // 토큰 보상 기록
            rewards.Add(new BattleRewardInfo
            {
                RewardType = BattleReward.REWARD_ITEM,
                ItemId = pvpToken.ItemId,
                ItemType = (byte)1,
                Quantity = 1,
                ItemName = pvpToken.Item.Name
            });
            
            dbRewards.Add(new BattleReward
            {
                BattleRecordId = battleRecordId,
                RewardType = BattleReward.REWARD_ITEM,
                ItemId = pvpToken.ItemId,
                ItemType = (byte)1,
                Quantity = 1,
                IsClaimed = true,
                ClaimedAt = DateTime.UtcNow
            });
        }
        
        // 보상 DB에 저장
        await _battleRepository.CreateBattleRewardsAsync(dbRewards);
        
        return rewards;
    }
}
```

### 12.5.2 전투 통계 서비스 구현

```csharp
// Services/Battle/BattleStatisticsService.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

public class BattleStatisticsService
{
    private readonly BattleRepository _battleRepository;
    
    public BattleStatisticsService(BattleRepository battleRepository)
    {
        _battleRepository = battleRepository;
    }
    
    // 플레이어의 스테이지 클리어 통계 조회
    public async Task<StageClearStatistics> GetStageClearStatisticsAsync(long playerId, int stageId)
    {
        // 스테이지 클리어 기록 조회
        var clearRecords = await _battleRepository.GetPlayerStageClearRecordsAsync(playerId, stageId);
        
        if (clearRecords == null || clearRecords.Count == 0)
        {
            return new StageClearStatistics
            {
                StageId = stageId,
                ClearCount = 0,
                BestClearTime = 0,
                AverageClearTime = 0,
                LastClearTime = null,
                BestDamage = 0,
                AverageDamage = 0
            };
        }
        
        // 통계 계산
        var bestRecord = clearRecords.OrderBy(r => r.BattleTime).First();
        var bestDamageRecord = clearRecords.OrderByDescending(r => r.TotalDamage).First();
        var lastRecord = clearRecords.OrderByDescending(r => r.ClearTime).First();
        
        int totalClearTime = clearRecords.Sum(r => r.BattleTime);
        int totalDamage = clearRecords.Sum(r => r.TotalDamage);
        
        return new StageClearStatistics
        {
            StageId = stageId,
            ClearCount = clearRecords.Count,
            BestClearTime = bestRecord.BattleTime,
            AverageClearTime = totalClearTime / clearRecords.Count,
            LastClearTime = lastRecord.ClearTime,
            BestDamage = bestDamageRecord.TotalDamage,
            AverageDamage = totalDamage / clearRecords.Count
        };
    }
    
    // 캐릭터 전투 성능 통계 조회
    public async Task<CharacterBattleStatistics> GetCharacterBattleStatisticsAsync(long playerId, long characterId)
    {
        // 캐릭터가 참여한 전투 기록 조회
        var details = await _battleRepository.Query()
            .From("battle_details as bd")
            .Join("battle_records as br", "br.id", "bd.battle_record_id")
            .Where("br.player_id", playerId)
            .Where("bd.character_id", characterId)
            .Where("bd.team_type", BattleDetail.TEAM_ALLY)
            .Select("bd.*", "br.result", "br.battle_type")
            .GetAsync<(BattleDetail, byte, byte)>();
            
        if (details == null || details.Count() == 0)
        {
            return new CharacterBattleStatistics
            {
                CharacterId = characterId,
                BattleCount = 0,
                WinCount = 0,
                WinRate = 0,
                TotalDamageDealt = 0,
                AverageDamageDealt = 0,
                TotalDamageTaken = 0,
                AverageDamageTaken = 0,
                TotalHealingDone = 0,
                AverageHealingDone = 0
            };
        }
        
        // 통계 계산
        int battleCount = details.Count();
        int winCount = details.Count(d => d.Item2 == BattleRecord.RESULT_WIN);
        int totalDamageDealt = details.Sum(d => d.Item1.DamageDealt);
        int totalDamageTaken = details.Sum(d => d.Item1.DamageTaken);
        int totalHealingDone = details.Sum(d => d.Item1.HealingDone);
        
        return new CharacterBattleStatistics
        {
            CharacterId = characterId,
            BattleCount = battleCount,
            WinCount = winCount,
            WinRate = (float)winCount / battleCount,
            TotalDamageDealt = totalDamageDealt,
            AverageDamageDealt = totalDamageDealt / battleCount,
            TotalDamageTaken = totalDamageTaken,
            AverageDamageTaken = totalDamageTaken / battleCount,
            TotalHealingDone = totalHealingDone,
            AverageHealingDone = totalHealingDone / battleCount
        };
    }
}

// 스테이지 클리어 통계 모델
public class StageClearStatistics
{
    public int StageId { get; set; }
    public int ClearCount { get; set; }
    public int BestClearTime { get; set; }
    public int AverageClearTime { get; set; }
    public DateTime? LastClearTime { get; set; }
    public int BestDamage { get; set; }
    public int AverageDamage { get; set; }
}

// 캐릭터 전투 통계 모델
public class CharacterBattleStatistics
{
    public long CharacterId { get; set; }
    public int BattleCount { get; set; }
    public int WinCount { get; set; }
    public float WinRate { get; set; }
    public int TotalDamageDealt { get; set; }
    public int AverageDamageDealt { get; set; }
    public int TotalDamageTaken { get; set; }
    public int AverageDamageTaken { get; set; }
    public int TotalHealingDone { get; set; }
    public int AverageHealingDone { get; set; }
}
```

## 12.6 Redis를 활용한 성능 최적화

```csharp
// Services/Cache/BattleCacheService.cs
using CloudStructures;
using CloudStructures.Structures;
using System;
using System.Threading.Tasks;

public class BattleCacheService
{
    private readonly RedisConnection _redisConnection;
    private readonly TimeSpan _battleLogExpiry = TimeSpan.FromHours(24);
    private readonly TimeSpan _stageDataExpiry = TimeSpan.FromDays(7);
    
    public BattleCacheService(RedisConnection redisConnection)
    {
        _redisConnection = redisConnection;
    }
    
    // 전투 로그 캐시 키
    private string GetBattleLogKey(long battleRecordId)
    {
        return $"battle:log:{battleRecordId}";
    }
    
    // 스테이지 데이터 캐시 키
    private string GetStageKey(int stageId)
    {
        return $"battle:stage:{stageId}";
    }
    
    // 전투 로그 캐싱
    public async Task SetBattleLogAsync(long battleRecordId, BattleLogResult log)
    {
        var redis = new RedisString<BattleLogResult>(_redisConnection, 
            GetBattleLogKey(battleRecordId), _battleLogExpiry);
        
        await redis.SetAsync(log);
    }
    
    // 전투 로그 조회
    public async Task<BattleLogResult> GetBattleLogAsync(long battleRecordId)
    {
        var redis = new RedisString<BattleLogResult>(_redisConnection, 
            GetBattleLogKey(battleRecordId), _battleLogExpiry);
        
        var result = await redis.GetAsync();
        return result.HasValue ? result.Value : null;
    }
    
    // 스테이지 데이터 캐싱
    public async Task SetStageAsync(int stageId, BattleStage stage)
    {
        var redis = new RedisString<BattleStage>(_redisConnection, 
            GetStageKey(stageId), _stageDataExpiry);
        
        await redis.SetAsync(stage);
    }
    
    // 스테이지 데이터 조회
    public async Task<BattleStage> GetStageAsync(int stageId)
    {
        var redis = new RedisString<BattleStage>(_redisConnection, 
            GetStageKey(stageId), _stageDataExpiry);
        
        var result = await redis.GetAsync();
        return result.HasValue ? result.Value : null;
    }
    
    // 전투 로그 캐시 무효화
    public async Task InvalidateBattleLogAsync(long battleRecordId)
    {
        var redis = new RedisKey(_redisConnection, GetBattleLogKey(battleRecordId));
        await redis.DeleteAsync();
    }
    
    // 스테이지 데이터 캐시 무효화
    public async Task InvalidateStageAsync(int stageId)
    {
        var redis = new RedisKey(_redisConnection, GetStageKey(stageId));
        await redis.DeleteAsync();
    }
}
```  
    
  
## 12.7 HTTP 테스트 파일 작성

클라이언트 코드 대신 .http 파일을 사용해 API를 테스트한다.

```http
// battle.http
@baseUrl = http://localhost:5000/api/battle
@playerId = 1001
@stageId = 101

### PvE 전투 시작
POST {{baseUrl}}/pve/start
Content-Type: application/json

{
    "PlayerId": {{playerId}},
    "StageId": {{stageId}},
    "PlayerTeam": [
        {
            "CharacterId": 1,
            "Position": 0
        },
        {
            "CharacterId": 2,
            "Position": 1
        },
        {
            "CharacterId": 3,
            "Position": 2
        }
    ]
}

### 전투 로그 조회
POST {{baseUrl}}/log
Content-Type: application/json

{
    "BattleRecordId": 1
}

### 전투 보상 조회
POST {{baseUrl}}/rewards
Content-Type: application/json

{
    "BattleRecordId": 1
}
```
  

## 요약
이 장에서는 ASP.NET Core Web API를 사용하여 수집형 RPG 게임의 전투 시스템을 구현했다. 주요 내용은 다음과 같다:

1. 전투 데이터 모델링 및 데이터베이스 설계
2. 턴 기반 전투 시뮬레이션 로직 구현
3. 전투 결과 계산 및 API 개발
4. 전투 로그 시스템 구현
5. 전투 보상 시스템 구현
6. Redis를 활용한 성능 최적화
7. HTTP 테스트 파일 작성

전투 시스템은 게임의 핵심 메커니즘으로, 서버 측에서 구현할 때는 정확성, 성능, 보안 등 여러 측면을 고려해야 한다. 이 장에서는 서버 부하를 고려한 결과 계산 방식과 주요 전투 과정을 함께 제공하는 하이브리드 접근법을 사용했다.

또한 다양한 유형의 전투(PvE, PvP)와 보상 시스템을 설계하고, 캐시를 활용해 성능을 최적화하는 방법도 살펴보았다. 전투 로그를 통해 게임 밸런싱과 분석에 필요한 데이터를 수집하는 방법도 함께 구현했다.
  
    


