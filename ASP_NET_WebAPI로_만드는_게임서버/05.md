# ASP.NET Core Web APIë¡œ ê²Œì„ ì„œë²„ ê°œë°œ
  
ì €ì: ìµœí¥ë°°, Claude AI   
-----------------------      
   
# 2ë¶€: ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ë° ê¸°ë³¸ ê¸°ëŠ¥ êµ¬í˜„
  
--------------     

# Chapter 5. MySQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
      
## 5.1 ê²Œì„ ì„œë²„ì—ì„œ MySQLì˜ ì—­í• 
ê²Œì„ ì„œë²„ì—ì„œ MySQLì€ í”Œë ˆì´ì–´ ì •ë³´, ìºë¦­í„° ë°ì´í„°, ì•„ì´í…œ ì¸ë²¤í† ë¦¬ ë“± ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•´ì•¼ í•  ë°ì´í„°ë¥¼ ê´€ë¦¬í•œë‹¤. ìˆ˜ì§‘í˜• RPG ê²Œì„ì—ì„œëŠ” íŠ¹íˆ ë‹¤ì–‘í•œ ìºë¦­í„°ì™€ ì•„ì´í…œ ì •ë³´, ì‚¬ìš©ì ì§„í–‰ ìƒíƒœ ë“±ì„ ì•ˆì •ì ìœ¼ë¡œ ì €ì¥í•˜ê³  ì¡°íšŒí•  í•„ìš”ê°€ ìˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚       â”‚                     â”‚
â”‚   ASP.NET Core      â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚     MySQL DB        â”‚
â”‚   Web API Server    â”‚       â”‚                     â”‚
â”‚                     â”‚       â”‚  - í”Œë ˆì´ì–´ ì •ë³´      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  - ìºë¦­í„° ë°ì´í„°      â”‚
                              â”‚  - ì•„ì´í…œ ì •ë³´       â”‚
                              â”‚  - í€˜ìŠ¤íŠ¸ ì§„í–‰ìƒíƒœ    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.2 MySqlConnector ì†Œê°œ
MySqlConnectorëŠ” MySQL ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ .NET ë°ì´í„° ê³µê¸‰ìë‹¤. ê¸°ì¡´ì˜ MySQL Connector/NET(MySql.Data)ë³´ë‹¤ ì„±ëŠ¥ì´ ë›°ì–´ë‚˜ê³  ë¹„ë™ê¸° ì‘ì—…ì„ ë” ì˜ ì§€ì›í•œë‹¤.

### 5.2.1 MySqlConnector ì„¤ì¹˜
í”„ë¡œì íŠ¸ì— MySqlConnectorë¥¼ ì„¤ì¹˜í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤:

```bash
dotnet add package MySqlConnector
```

### 5.2.2 ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
`appsettings.json` íŒŒì¼ì— MySQL ì—°ê²° ë¬¸ìì—´ì„ ì¶”ê°€í•œë‹¤:

```json
{
  "ConnectionStrings": {
    "GameDatabase": "Server=localhost;Database=rpg_game;User=gameuser;Password=password;SslMode=none;"
  }
}
```
  

## 5.3 MySqlConnector ê¸°ë³¸ ì‚¬ìš©ë²•

### 5.3.1 ì—°ê²° ë° ê¸°ë³¸ ì¿¼ë¦¬ ì‹¤í–‰
ë‹¤ìŒì€ MySqlConnectorë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°í•˜ê³  ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ëŠ” ê¸°ë³¸ ì˜ˆì œë‹¤:

```csharp
using MySqlConnector;
using System.Threading.Tasks;

public class PlayerRepository
{
    private readonly string _connectionString;

    public PlayerRepository(string connectionString)
    {
        _connectionString = connectionString;
    }

    public async Task<Player> GetPlayerByIdAsync(int playerId)
    {
        using var connection = new MySqlConnection(_connectionString);
        await connection.OpenAsync();

        using var command = connection.CreateCommand();
        command.CommandText = "SELECT id, username, level, experience FROM players WHERE id = @playerId";
        command.Parameters.AddWithValue("@playerId", playerId);

        using var reader = await command.ExecuteReaderAsync();
        if (await reader.ReadAsync())
        {
            return new Player
            {
                Id = reader.GetInt32(0),
                Username = reader.GetString(1),
                Level = reader.GetInt32(2),
                Experience = reader.GetInt32(3)
            };
        }

        return null;
    }
}
```
  
#### ì½”ë“œ ë™ì‘ ìˆœì„œ (ë‹¨ê³„ë³„ ì„¤ëª…)
ì½”ë“œëŠ” `GetPlayerByIdAsync` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ë©´ ì•„ë˜ ìˆœì„œëŒ€ë¡œ ë™ì‘í•œë‹¤.

1.  **ì´ˆê¸°í™”**: `PlayerRepository` ê°ì²´ê°€ ìƒì„±ë  ë•Œ ì™¸ë¶€ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ **ì—°ê²° ì •ë³´(`connectionString`)**ë¥¼ ë°›ì•„ì™€ ì €ì¥í•œë‹¤.

2.  **DB ì—°ê²° (Connect)**: `MySqlConnection` ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , `connection.OpenAsync()`ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì— **ë¹„ë™ê¸°ì ìœ¼ë¡œ ì—°ê²°**ì„ ì‹œë„í•œë‹¤.

3.  **ëª…ë ¹ ìƒì„± (Create Command)**: ì‹¤í–‰í•  SQL ì¿¼ë¦¬(`SELECT ...`)ë¥¼ ë‹´ì„ `MySqlCommand` ê°ì²´ë¥¼ ë§Œë“ ë‹¤.

4.  **íŒŒë¼ë¯¸í„° ì„¤ì • (Set Parameter)**: SQL ì¿¼ë¦¬ë¬¸ ì•ˆì˜ `@playerId`ë¼ëŠ” placeholder(ìë¦¬ í‘œì‹œì)ì— ë©”ì„œë“œë¡œ ì „ë‹¬ë°›ì€ `playerId` ê°’ì„ **ì•ˆì „í•˜ê²Œ ì„¤ì •**í•œë‹¤.

5.  **ì¿¼ë¦¬ ì‹¤í–‰ (Execute)**: `command.ExecuteReaderAsync()`ë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì¿¼ë¦¬ë¥¼ **ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰**í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ì½ì„ ìˆ˜ ìˆëŠ” `MySqlDataReader` ê°ì²´ë¥¼ ë°›ëŠ”ë‹¤.

6.  **ê²°ê³¼ í™•ì¸ ë° ë³€í™˜ (Read & Map)**:
    * `reader.ReadAsync()`ë¥¼ í†µí•´ ê²°ê³¼ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
    * ë°ì´í„°ê°€ **ìˆë‹¤ë©´**(í”Œë ˆì´ì–´ë¥¼ ì°¾ì•˜ë‹¤ë©´), ê° ì»¬ëŸ¼ì˜ ê°’ì„ ì¸ë±ìŠ¤(`0`, `1`, `2`...)ë¡œ ì½ì–´ì™€ ìƒˆë¡œìš´ `Player` ê°ì²´ë¥¼ ë§Œë“¤ì–´ ê·¸ ê°’ì„ ì±„ìš´ ë’¤ ë°˜í™˜í•œë‹¤.
    * ë°ì´í„°ê°€ **ì—†ë‹¤ë©´**(í”Œë ˆì´ì–´ë¥¼ ëª» ì°¾ì•˜ë‹¤ë©´), `null`ì„ ë°˜í™˜í•œë‹¤.

7.  **ë¦¬ì†ŒìŠ¤ í•´ì œ (Dispose)**: `using` ë¬¸ ë•ë¶„ì— ë©”ì„œë“œê°€ ì¢…ë£Œë  ë•Œ(ê°’ì„ ë°˜í™˜í•˜ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ) ì‚¬ìš©í–ˆë˜ `connection`, `command`, `reader` ê°ì²´ë“¤ì´ **ìë™ìœ¼ë¡œ ì •ë¦¬**ëœë‹¤.
  

### 5.3.2 íŠ¸ëœì­ì…˜ ì‚¬ìš©
ê²Œì„ì—ì„œ ì•„ì´í…œ êµí™˜ì´ë‚˜ ìºë¦­í„° ê°•í™”ì™€ ê°™ì€ ì‘ì—…ì€ ì—¬ëŸ¬ ì¿¼ë¦¬ê°€ ëª¨ë‘ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤. ì´ëŸ° ê²½ìš° íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•œë‹¤:  
  
```csharp
public async Task<bool> EnhanceCharacterAsync(int characterId, int itemId)
{
    using var connection = new MySqlConnection(_connectionString);
    await connection.OpenAsync();

    using var transaction = await connection.BeginTransactionAsync();
    
    try
    {
        // 1. ìºë¦­í„° ê°•í™” ì•„ì´í…œ í™•ì¸
        using var checkCommand = connection.CreateCommand();
        checkCommand.Transaction = transaction;
        checkCommand.CommandText = "SELECT count(*) FROM player_items WHERE id = @itemId AND item_type = 'enhancement'";
        checkCommand.Parameters.AddWithValue("@itemId", itemId);
        
        var itemExists = (long)await checkCommand.ExecuteScalarAsync() > 0;
        if (!itemExists)
        {
            await transaction.RollbackAsync();
            return false;
        }
        
        // 2. ìºë¦­í„° ëŠ¥ë ¥ì¹˜ ì¦ê°€
        using var updateCommand = connection.CreateCommand();
        updateCommand.Transaction = transaction;
        updateCommand.CommandText = "UPDATE characters SET power = power + 10, level = level + 1 WHERE id = @characterId";
        updateCommand.Parameters.AddWithValue("@characterId", characterId);
        await updateCommand.ExecuteNonQueryAsync();
        
        // 3. ì†Œëª¨ëœ ì•„ì´í…œ ì œê±°
        using var deleteCommand = connection.CreateCommand();
        deleteCommand.Transaction = transaction;
        deleteCommand.CommandText = "DELETE FROM player_items WHERE id = @itemId";
        deleteCommand.Parameters.AddWithValue("@itemId", itemId);
        await deleteCommand.ExecuteNonQueryAsync();
        
        await transaction.CommitAsync();
        return true;
    }
    catch (Exception)
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```

### ì°¸ê³  ìë£Œ 
- [MySqlConnector ê°„ë‹¨ ì •ë¦¬](https://gist.github.com/jacking75/51a1c96f4efa1b7a27030a7410f39bc6 )  

 
## 5.4 SqlKata ì†Œê°œ
SqlKataëŠ” SQL ì¿¼ë¦¬ ë¹Œë”ë¡œ, íƒ€ì… ì•ˆì „ì„±ê³¼ ê°€ë…ì„±ì„ ë†’ì—¬ì£¼ëŠ” ë„êµ¬ë‹¤. ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œì„ ì§€ì›í•˜ë©°, ë³µì¡í•œ SQL ì¿¼ë¦¬ë¥¼ C# ì½”ë“œë¡œ ì‰½ê²Œ ì‘ì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.  
[SqlKata](https://sqlkata.com )  

### 5.4.1 SqlKata ì„¤ì¹˜
í”„ë¡œì íŠ¸ì— SqlKataì™€ MySqlConnectorìš© ì»´íŒŒì¼ëŸ¬ë¥¼ ì„¤ì¹˜í•œë‹¤:  

```bash
dotnet add package SqlKata
dotnet add package SqlKata.Execution
```

### 5.4.2 SqlKata ì„¤ì •
ë‹¤ìŒì€ SqlKataë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•ì´ë‹¤:

```csharp
using SqlKata.Compilers;
using SqlKata.Execution;


IDbConnection _dbConn = new MySqlConnection(_dbConfig.Value.AccountDb);
_dbConn.Open();

SqlKata.Compilers.MySqlCompiler _compiler;
QueryFactory _queryFactory;  

_compiler = new SqlKata.Compilers.MySqlCompiler();
_queryFactory = new SqlKata.Execution.QueryFactory(_dbConn, _compiler);

// ì‚¬ìš©í•˜ê¸°
var count = await _queryFactory.Query("account").InsertAsync(new {
                                                                   Email = email,
                                                                   SaltValue = saltValue,
                                                                   HashedPassword = hashingPassword
                                                                 });
```
    
    
## 5.5 SqlKata ì¿¼ë¦¬ ë¹Œë” íŒ¨í„´ í™œìš©
SqlKataë¥¼ ì‚¬ìš©í•˜ë©´ SQL ì¿¼ë¦¬ë¥¼ C# ì½”ë“œë¡œ í‘œí˜„í•  ìˆ˜ ìˆì–´ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì„±ì´ í–¥ìƒëœë‹¤.

### 5.5.1 ê¸°ë³¸ ì¿¼ë¦¬ ì‘ì„±

```csharp
public class PlayerRepository
{
    private readonly QueryFactory _db;

    public PlayerRepository(QueryFactory db)
    {
        _db = db;
    }

    public async Task<Player> GetPlayerByIdAsync(int playerId)
    {
        return await _db.Query("players")
            .Where("id", playerId)
            .FirstOrDefaultAsync<Player>();
    }

    public async Task<List<Player>> GetTopPlayersByLevelAsync(int limit = 10)
    {
        return await _db.Query("players")
            .OrderByDesc("level")
            .ThenByDesc("experience")
            .LimitAsync<Player>(limit);
    }
}
```

### 5.5.2 ë³µì¡í•œ ì¿¼ë¦¬ ì‘ì„±

```csharp
public async Task<List<CharacterWithItems>> GetCharactersWithItemsAsync(int playerId)
{
    var query = _db.Query("characters as c")
        .Select("c.id", "c.name", "c.level", "c.class", "c.power")
        .Where("c.player_id", playerId)
        .OrderByDesc("c.level");
        
    var characters = await query.GetAsync<Character>();
    
    var result = new List<CharacterWithItems>();
    
    foreach (var character in characters)
    {
        var items = await _db.Query("character_items as ci")
            .Join("items as i", "i.id", "ci.item_id")
            .Select("i.id", "i.name", "i.type", "i.rarity", "i.stat_bonus")
            .Where("ci.character_id", character.Id)
            .GetAsync<Item>();
            
        result.Add(new CharacterWithItems
        {
            Character = character,
            Items = items.ToList()
        });
    }
    
    return result;
}
```
    
#### 1. ì²« ë²ˆì§¸ ì¿¼ë¦¬: í”Œë ˆì´ì–´ì˜ ìºë¦­í„° ëª©ë¡ ì¡°íšŒ ğŸ”

```csharp
var query = _db.Query("characters as c")
Â  Â  .Select("c.id", "c.name", "c.level", "c.class", "c.power")
Â  Â  .Where("c.player_id", playerId)
Â  Â  .OrderByDesc("c.level");
```

ì´ ì½”ë“œëŠ” C# ì½”ë“œë¡œ SQL ì¿¼ë¦¬ë¥¼ ë§Œë“œëŠ” **ì¿¼ë¦¬ ë¹Œë”(Query Builder)** êµ¬ë¬¸ì…ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì‹¤í–‰ë  ë•ŒëŠ” ì•„ë˜ì™€ ê°™ì€ SQL ë¬¸ìœ¼ë¡œ ë³€í™˜ëœë‹¤.
  
```sql
SELECT
Â  c.id,
Â  c.name,
Â  c.level,
Â  c.class,
Â  c.power
FROM characters AS c
WHERE c.player_id = @playerId -- @playerIdì—ëŠ” ì…ë ¥ë°›ì€ playerId ê°’ì´ ë“¤ì–´ê°
ORDER BY c.level DESC;
```

  * **FROM `characters` AS `c`**: `characters` í…Œì´ë¸”ì„ `c`ë¼ëŠ” ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
  * **SELECT `c.id`, `c.name`, ...**: `c` í…Œì´ë¸”(ì¦‰, `characters` í…Œì´ë¸”)ì—ì„œ `id`, `name` ë“± ì§€ì •ëœ ì»¬ëŸ¼ë“¤ì„ ì„ íƒí•œë‹¤.
  * **WHERE `c.player_id` = @playerId**: **`player_id`**ê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ `playerId`ì™€ ì¼ì¹˜í•˜ëŠ” ìºë¦­í„°ë§Œ í•„í„°ë§í•œë‹¤.
  * **ORDER BY `c.level` DESC**: ì¡°íšŒëœ ìºë¦­í„° ëª©ë¡ì„ **`level`** ê¸°ì¤€ìœ¼ë¡œ **ë‚´ë¦¼ì°¨ìˆœ(DESC)** ì •ë ¬í•œë‹¤. ì¦‰, ë ˆë²¨ì´ ë†’ì€ ìºë¦­í„°ë¶€í„° ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜¨ë‹¤.  
  
**ê²°ë¡ ì ìœ¼ë¡œ ì´ ì¿¼ë¦¬ëŠ” íŠ¹ì • í”Œë ˆì´ì–´ì˜ ëª¨ë“  ìºë¦­í„°ë¥¼ ë ˆë²¨ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì ¸ì˜¤ëŠ” ì—­í• ì„ í•œë‹¤.**


#### 2. ë‘ ë²ˆì§¸ ì¿¼ë¦¬: ê° ìºë¦­í„°ì˜ ì•„ì´í…œ ëª©ë¡ ì¡°íšŒ (ë°˜ë³µ ì‹¤í–‰) ğŸ”„
  
```csharp
var items = await _db.Query("character_items as ci")
Â  Â  .Join("items as i", "i.id", "ci.item_id")
Â  Â  .Select("i.id", "i.name", "i.type", "i.rarity", "i.stat_bonus")
Â  Â  .Where("ci.character_id", character.Id)
Â  Â  .GetAsync<Item>();
```

ì´ ì¿¼ë¦¬ëŠ” ì²« ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ê°€ì ¸ì˜¨ ìºë¦­í„° ëª©ë¡ì„ ìˆœíšŒí•˜ëŠ” **`foreach` ë°˜ë³µë¬¸ ì•ˆì—ì„œ ì‹¤í–‰**ëœë‹¤. ì¦‰, **ìºë¦­í„°ì˜ ìˆ˜ë§Œí¼ ë°˜ë³µí•´ì„œ ì‹¤í–‰**ëœë‹¤.

ì´ êµ¬ë¬¸ì´ ë³€í™˜ë˜ëŠ” SQL ë¬¸ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.  
  
```sql
SELECT
Â  i.id,
Â  i.name,
Â  i.type,
Â  i.rarity,
Â  i.stat_bonus
FROM character_items AS ci
JOIN items AS i ON i.id = ci.item_id
WHERE ci.character_id = @characterId; -- @characterIdì—ëŠ” ë£¨í”„ ì¤‘ì¸ í˜„ì¬ ìºë¦­í„°ì˜ IDê°€ ë“¤ì–´ê°
```

  * **FROM `character_items` AS `ci`**: ìºë¦­í„°ì™€ ì•„ì´í…œì˜ ê´€ê³„ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ê°„ í…Œì´ë¸”ì¸ `character_items`ë¥¼ `ci`ë¼ëŠ” ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.
  * **JOIN `items` AS `i` ON `i.id` = `ci.item_id`**: `character_items` í…Œì´ë¸”ê³¼ `items` í…Œì´ë¸”ì„ **`JOIN`** í•©ë‹ˆë‹¤. `ci` í…Œì´ë¸”ì˜ `item_id`ì™€ `i` í…Œì´ë¸”ì˜ `id`ê°€ ê°™ì€ ë°ì´í„°ë¥¼ ì—°ê²°í•˜ì—¬, ìºë¦­í„°ê°€ ì¥ì°©í•œ ì•„ì´í…œì˜ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í•œë‹¤.
  * **SELECT `i.id`, `i.name`, ...**: `items` í…Œì´ë¸”ì—ì„œ ì•„ì´í…œì˜ ìƒì„¸ ì •ë³´ ì»¬ëŸ¼ë“¤ì„ ì„ íƒí•œë‹¤.
  * **WHERE `ci.character_id` = @characterId**: `character_items` í…Œì´ë¸”ì—ì„œ í˜„ì¬ ë£¨í”„ ì¤‘ì¸ **íŠ¹ì • ìºë¦­í„°ì˜ ID(`character.Id`)**ì™€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë§Œ í•„í„°ë§í•œë‹¤.

**ê²°ë¡ ì ìœ¼ë¡œ ì´ ì¿¼ë¦¬ëŠ” íŠ¹ì • ìºë¦­í„° í•œ ëª…ì´ ì¥ì°©í•˜ê³  ìˆëŠ” ëª¨ë“  ì•„ì´í…œì˜ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—­í• ì„ í•œë‹¤.**  
  
  
### 5.5.3 ì¡°ê±´ë¶€ ì¿¼ë¦¬ êµ¬ì„±

```csharp
public async Task<List<Character>> SearchCharactersAsync(CharacterSearchFilter filter)
{
    var query = _db.Query("characters");
    
    if (filter.PlayerId.HasValue)
    {
        query = query.Where("player_id", filter.PlayerId.Value);
    }
    
    if (!string.IsNullOrEmpty(filter.Name))
    {
        query = query.WhereLike("name", $"%{filter.Name}%");
    }
    
    if (filter.MinLevel.HasValue)
    {
        query = query.Where("level", ">=", filter.MinLevel.Value);
    }
    
    if (filter.MaxLevel.HasValue)
    {
        query = query.Where("level", "<=", filter.MaxLevel.Value);
    }
    
    if (!string.IsNullOrEmpty(filter.Class))
    {
        query = query.Where("class", filter.Class);
    }
    
    if (filter.SortBy == "level")
    {
        query = filter.SortDirection == "desc" 
            ? query.OrderByDesc("level") 
            : query.OrderBy("level");
    }
    else
    {
        query = filter.SortDirection == "desc" 
            ? query.OrderByDesc("power") 
            : query.OrderBy("power");
    }
    
    return await query.LimitAsync<Character>(filter.Limit ?? 20);
}
```
    

## 5.6 ì‹¤ì œ ê²Œì„ ì‹œìŠ¤í…œ êµ¬í˜„ ì˜ˆì œ
ì´ì œ ì‹¤ì œ ê²Œì„ ì„œë²„ì˜ API ì—”ë“œí¬ì¸íŠ¸ì™€ MySqlConnector ë° SqlKataë¥¼ í™œìš©í•œ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µì„ êµ¬í˜„í•´ë³´ì.
  
### 5.6.1 í”Œë ˆì´ì–´ ëª¨ë¸ ë° ë¦¬í¬ì§€í† ë¦¬

**ëª¨ë¸:**  

```csharp
// Models/Player.cs
public class Player
{
    public int Id { get; set; }
    public string Username { get; set; }
    public int Level { get; set; }
    public int Experience { get; set; }
    public int Gold { get; set; }
    public int Gems { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime LastLoginAt { get; set; }
}

public class PlayerResponse
{
    public bool Success { get; set; }
    public Player Data { get; set; }
    public string Message { get; set; }
}

public class PlayerListResponse
{
    public bool Success { get; set; }
    public List<Player> Data { get; set; }
    public string Message { get; set; }
}
```

**ë¦¬í¬ì§€í† ë¦¬:**  

```csharp
// Repositories/PlayerRepository.cs
public class PlayerRepository : IPlayerRepository
{
    private readonly QueryFactory _db;

    public PlayerRepository(QueryFactory db)
    {
        _db = db;
    }

    public async Task<Player> GetByIdAsync(int id)
    {
        return await _db.Query("players")
            .Where("id", id)
            .FirstOrDefaultAsync<Player>();
    }

    public async Task<Player> GetByUsernameAsync(string username)
    {
        return await _db.Query("players")
            .Where("username", username)
            .FirstOrDefaultAsync<Player>();
    }

    public async Task<int> CreateAsync(Player player)
    {
        player.CreatedAt = DateTime.UtcNow;
        player.LastLoginAt = DateTime.UtcNow;
        
        return await _db.Query("players").InsertGetIdAsync<int>(new
        {
            player.Username,
            player.Level,
            player.Experience,
            player.Gold,
            player.Gems,
            player.CreatedAt,
            player.LastLoginAt
        });
    }

    public async Task<bool> UpdateAsync(Player player)
    {
        var affected = await _db.Query("players")
            .Where("id", player.Id)
            .UpdateAsync(new
            {
                player.Level,
                player.Experience,
                player.Gold,
                player.Gems,
                player.LastLoginAt
            });
            
        return affected > 0;
    }

    public async Task<List<Player>> GetTopPlayersAsync(int limit = 10)
    {
        return await _db.Query("players")
            .OrderByDesc("level")
            .ThenByDesc("experience")
            .LimitAsync<Player>(limit);
    }
}
```
  
  
### 5.6.2 ì»¨íŠ¸ë¡¤ëŸ¬ êµ¬í˜„

```csharp
// Controllers/PlayerController.cs
[ApiController]
[Route("api/[controller]")]
public class PlayerController : ControllerBase
{
    private readonly IPlayerRepository _playerRepository;

    public PlayerController(IPlayerRepository playerRepository)
    {
        _playerRepository = playerRepository;
    }

    [HttpPost("get")]
    public async Task<PlayerResponse> GetPlayer([FromBody] GetPlayerRequest request)
    {
        var player = await _playerRepository.GetByIdAsync(request.PlayerId);
        
        if (player == null)
        {
            return new PlayerResponse 
            { 
                Success = false, 
                Message = "í”Œë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." 
            };
        }
        
        return new PlayerResponse
        {
            Success = true,
            Data = player
        };
    }

    [HttpPost("create")]
    public async Task<PlayerResponse> CreatePlayer([FromBody] CreatePlayerRequest request)
    {
        var existingPlayer = await _playerRepository.GetByUsernameAsync(request.Username);
        
        if (existingPlayer != null)
        {
            return new PlayerResponse 
            { 
                Success = false, 
                Message = "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì…ë‹ˆë‹¤." 
            };
        }
        
        var player = new Player
        {
            Username = request.Username,
            Level = 1,
            Experience = 0,
            Gold = 1000,
            Gems = 100
        };
        
        player.Id = await _playerRepository.CreateAsync(player);
        
        return new PlayerResponse
        {
            Success = true,
            Data = player,
            Message = "í”Œë ˆì´ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
        };
    }

    [HttpPost("top")]
    public async Task<PlayerListResponse> GetTopPlayers([FromBody] GetTopPlayersRequest request)
    {
        var limit = request.Limit > 0 ? request.Limit : 10;
        var players = await _playerRepository.GetTopPlayersAsync(limit);
        
        return new PlayerListResponse
        {
            Success = true,
            Data = players
        };
    }
}
```

### 5.6.3 ìš”ì²­ ë° ì‘ë‹µ ëª¨ë¸

```csharp
// Models/Requests/PlayerRequests.cs
public class GetPlayerRequest
{
    public int PlayerId { get; set; }
}

public class CreatePlayerRequest
{
    public string Username { get; set; }
}

public class GetTopPlayersRequest
{
    public int Limit { get; set; } = 10;
}
```
  

### 5.6.4 HTTP ìš”ì²­ í…ŒìŠ¤íŠ¸ íŒŒì¼

```
### í”Œë ˆì´ì–´ ìƒì„±
POST https://localhost:5001/api/player/create
Content-Type: application/json

{
  "username": "dragon_slayer"
}

### í”Œë ˆì´ì–´ ì •ë³´ ì¡°íšŒ
POST https://localhost:5001/api/player/get
Content-Type: application/json

{
  "playerId": 1
}

### ìµœìƒìœ„ í”Œë ˆì´ì–´ ëª©ë¡ ì¡°íšŒ
POST https://localhost:5001/api/player/top
Content-Type: application/json

{
  "limit": 5
}
```
  
  
## 5.7 ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ì´ˆê¸° ì„¤ì •
ê²Œì„ ì„œë²„ ê°œë°œì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì½”ë“œë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤. ë‹¤ìŒì€ ê²Œì„ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ë‹¤:  
  
```sql
-- í”Œë ˆì´ì–´ í…Œì´ë¸”
CREATE TABLE players (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    level INT NOT NULL DEFAULT 1,
    experience INT NOT NULL DEFAULT 0,
    gold INT NOT NULL DEFAULT 1000,
    gems INT NOT NULL DEFAULT 100,
    created_at DATETIME NOT NULL,
    last_login_at DATETIME NOT NULL,
    INDEX idx_username (username),
    INDEX idx_level (level)
);

-- ìºë¦­í„° í…Œì´ë¸”
CREATE TABLE characters (
    id INT AUTO_INCREMENT PRIMARY KEY,
    player_id INT NOT NULL,
    name VARCHAR(50) NOT NULL,
    class VARCHAR(30) NOT NULL,
    level INT NOT NULL DEFAULT 1,
    experience INT NOT NULL DEFAULT 0,
    power INT NOT NULL DEFAULT 100,
    created_at DATETIME NOT NULL,
    INDEX idx_player_id (player_id),
    INDEX idx_class (class),
    INDEX idx_level (level)
);

-- ì•„ì´í…œ ë§ˆìŠ¤í„° í…Œì´ë¸”
CREATE TABLE items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    type VARCHAR(30) NOT NULL,
    rarity VARCHAR(20) NOT NULL,
    stat_bonus JSON,
    icon_url VARCHAR(255)
);

-- í”Œë ˆì´ì–´ ì†Œìœ  ì•„ì´í…œ í…Œì´ë¸”
CREATE TABLE player_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    player_id INT NOT NULL,
    item_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    acquired_at DATETIME NOT NULL,
    INDEX idx_player_id (player_id)
);

-- ìºë¦­í„° ì¥ì°© ì•„ì´í…œ í…Œì´ë¸”
CREATE TABLE character_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    character_id INT NOT NULL,
    item_id INT NOT NULL,
    slot VARCHAR(30) NOT NULL,
    equipped_at DATETIME NOT NULL,
    UNIQUE KEY unique_character_slot (character_id, slot),
    INDEX idx_character_id (character_id)
);

-- í€˜ìŠ¤íŠ¸ í…Œì´ë¸”
CREATE TABLE quests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    min_level INT NOT NULL DEFAULT 1,
    rewards JSON NOT NULL,
    type VARCHAR(30) NOT NULL
);

-- í”Œë ˆì´ì–´ í€˜ìŠ¤íŠ¸ ìƒíƒœ í…Œì´ë¸”
CREATE TABLE player_quests (
    id INT AUTO_INCREMENT PRIMARY KEY,
    player_id INT NOT NULL,
    quest_id INT NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'available',
    progress JSON,
    completed_at DATETIME NULL,
    UNIQUE KEY unique_player_quest (player_id, quest_id),
    INDEX idx_player_id (player_id),
    INDEX idx_status (status)
);
```
  

## 5.8 ì¿¼ë¦¬ ìµœì í™” ë° ì„±ëŠ¥ í–¥ìƒ ê¸°ë²•
ê²Œì„ ì„œë²„ëŠ” ë§ì€ ë™ì‹œ ì ‘ì†ìë¥¼ ì²˜ë¦¬í•´ì•¼ í•˜ë¯€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”ê°€ ì¤‘ìš”í•˜ë‹¤.

### 5.8.1 ì¸ë±ìŠ¤ ì„¤ê³„
ì ì ˆí•œ ì¸ë±ìŠ¤ ì„¤ê³„ëŠ” ì¿¼ë¦¬ ì„±ëŠ¥ì— í° ì˜í–¥ì„ ë¯¸ì¹œë‹¤:

```csharp
// ì¸ë±ìŠ¤ ìƒì„± ì˜ˆì œ
await _db.Statement("CREATE INDEX idx_player_level_exp ON players(level DESC, experience DESC)");
```

### 5.8.2 ì¿¼ë¦¬ ìºì‹±
ìì£¼ ì¡°íšŒë˜ì§€ë§Œ ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠëŠ” ë°ì´í„°ëŠ” Redisë¥¼ ì‚¬ìš©í•´ ìºì‹±í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤:

```csharp
public async Task<List<Player>> GetTopPlayersAsync(int limit = 10)
{
    var cacheKey = $"top_players:{limit}";
    
    // Redisì—ì„œ ìºì‹œëœ ê²°ê³¼ í™•ì¸
    var cachedResult = await _redisCache.GetAsync<List<Player>>(cacheKey);
    if (cachedResult != null)
    {
        return cachedResult;
    }
    
    // ìºì‹œì— ì—†ìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ
    var players = await _db.Query("players")
        .OrderByDesc("level")
        .ThenByDesc("experience")
        .LimitAsync<Player>(limit);
    
    // ê²°ê³¼ë¥¼ ìºì‹œì— ì €ì¥ (1ì‹œê°„ ë§Œë£Œ)
    await _redisCache.SetAsync(cacheKey, players, TimeSpan.FromHours(1));
    
    return players;
}
```

### 5.8.3 ë°°ì¹˜ ì²˜ë¦¬
ì—¬ëŸ¬ í”Œë ˆì´ì–´ì—ê²Œ ë³´ìƒ ì§€ê¸‰ ê°™ì€ ëŒ€ëŸ‰ ì‘ì—…ì€ ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤:

```csharp
public async Task<int> GiveRewardsToPlayersAsync(List<PlayerReward> rewards)
{
    // ë°°ì¹˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ íŠ¸ëœì­ì…˜ ì‹œì‘
    using var connection = new MySqlConnection(_connectionString);
    await connection.OpenAsync();
    using var transaction = await connection.BeginTransactionAsync();
    
    try
    {
        var factory = new QueryFactory(connection, new MySqlCompiler());
        factory.Transaction = transaction;
        
        int successCount = 0;
        
        foreach (var batch in rewards.Chunk(100)) // 100ê°œì”© ì²˜ë¦¬
        {
            var updateTasks = batch.Select(async reward =>
            {
                var affected = await factory.Query("players")
                    .Where("id", reward.PlayerId)
                    .IncrementAsync(new Dictionary<string, object>
                    {
                        { "gold", reward.Gold },
                        { "gems", reward.Gems },
                        { "experience", reward.Experience }
                    });
                    
                if (affected > 0)
                {
                    // ë³´ìƒ ì§€ê¸‰ ë¡œê·¸ ê¸°ë¡
                    await factory.Query("reward_logs").InsertAsync(new
                    {
                        player_id = reward.PlayerId,
                        gold = reward.Gold,
                        gems = reward.Gems,
                        experience = reward.Experience,
                        reason = reward.Reason,
                        timestamp = DateTime.UtcNow
                    });
                    
                    return 1;
                }
                
                return 0;
            });
            
            var batchResults = await Task.WhenAll(updateTasks);
            successCount += batchResults.Sum();
        }
        
        await transaction.CommitAsync();
        return successCount;
    }
    catch
    {
        await transaction.RollbackAsync();
        throw;
    }
}
```
  

## 5.9 ì¢…í•© ì˜ˆì œ: ê²Œì„ ì•„ì´í…œ ìƒì  ì‹œìŠ¤í…œ
ë§ˆì§€ë§‰ìœ¼ë¡œ, MySqlConnectorì™€ SqlKataë¥¼ í™œìš©í•œ ê²Œì„ ë‚´ ìƒì  ì‹œìŠ¤í…œì„ êµ¬í˜„í•´ë³´ì.

### 5.9.1 ìƒì  ì•„ì´í…œ ëª¨ë¸

```csharp
// Models/Shop/ShopItem.cs
public class ShopItem
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public string Type { get; set; }
    public string Rarity { get; set; }
    public int Price { get; set; }
    public string CurrencyType { get; set; } // "gold" ë˜ëŠ” "gems"
    public bool IsLimited { get; set; }
    public int? RemainingStock { get; set; }
    public DateTime? AvailableUntil { get; set; }
}

public class ShopItemResponse
{
    public bool Success { get; set; }
    public List<ShopItem> Items { get; set; }
    public string Message { get; set; }
}

public class PurchaseRequest
{
    public int PlayerId { get; set; }
    public int ShopItemId { get; set; }
    public int Quantity { get; set; } = 1;
}

public class PurchaseResponse
{
    public bool Success { get; set; }
    public Player UpdatedPlayer { get; set; }
    public List<PlayerItem> AcquiredItems { get; set; }
    public string Message { get; set; }
}
```

### 5.9.2 ìƒì  ë¦¬í¬ì§€í† ë¦¬

```csharp
// Repositories/ShopRepository.cs
public class ShopRepository : IShopRepository
{
    private readonly QueryFactory _db;

    public ShopRepository(QueryFactory db)
    {
        _db = db;
    }

    public async Task<List<ShopItem>> GetAvailableItemsAsync()
    {
        var now = DateTime.UtcNow;
        
        return await _db.Query("shop_items")
            .Where(q => q
                .WhereNull("available_until")
                .OrWhere("available_until", ">", now))
            .Where(q => q
                .WhereNull("remaining_stock")
                .OrWhere("remaining_stock", ">", 0))
            .OrderBy("price")
            .GetAsync<ShopItem>();
    }

    public async Task<ShopItem> GetShopItemByIdAsync(int id)
    {
        return await _db.Query("shop_items")
            .Where("id", id)
            .FirstOrDefaultAsync<ShopItem>();
    }

    public async Task<bool> ReduceStockAsync(int shopItemId, int quantity)
    {
        var affected = await _db.Query("shop_items")
            .Where("id", shopItemId)
            .Where(q => q
                .WhereNull("remaining_stock")
                .OrWhere("remaining_stock", ">=", quantity))
            .DecrementAsync("remaining_stock", quantity);
            
        return affected > 0;
    }
}
```

### 5.9.3 ìƒì  ì„œë¹„ìŠ¤

```csharp
// Services/ShopService.cs
public class ShopService : IShopService
{
    private readonly IShopRepository _shopRepository;
    private readonly IPlayerRepository _playerRepository;
    private readonly IPlayerItemRepository _playerItemRepository;
    private readonly ILogger<ShopService> _logger;

    public ShopService(
        IShopRepository shopRepository,
        IPlayerRepository playerRepository,
        IPlayerItemRepository playerItemRepository,
        ILogger<ShopService> logger)
    {
        _shopRepository = shopRepository;
        _playerRepository = playerRepository;
        _playerItemRepository = playerItemRepository;
        _logger = logger;
    }

    public async Task<(bool Success, List<ShopItem> Items, string Message)> GetShopItemsAsync()
    {
        try
        {
            var items = await _shopRepository.GetAvailableItemsAsync();
            return (true, items, null);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "ìƒì  ì•„ì´í…œì„ ì¡°íšŒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            return (false, null, "ìƒì  ì•„ì´í…œì„ ì¡°íšŒí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    public async Task<(bool Success, Player UpdatedPlayer, List<PlayerItem> AcquiredItems, string Message)> PurchaseItemAsync(
        int playerId, int shopItemId, int quantity)
    {
        using var connection = new MySqlConnection(_connectionString);
        await connection.OpenAsync();
        using var transaction = await connection.BeginTransactionAsync();
        
        try
        {
            var factory = new QueryFactory(connection, new MySqlCompiler())
            {
                Transaction = transaction
            };
            
            // 1. í”Œë ˆì´ì–´ ì •ë³´ ì¡°íšŒ
            var player = await factory.Query("players")
                .Where("id", playerId)
                .FirstOrDefaultAsync<Player>();
                
            if (player == null)
            {
                await transaction.RollbackAsync();
                return (false, null, null, "í”Œë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            
            // 2. ìƒì  ì•„ì´í…œ ì •ë³´ ì¡°íšŒ
            var shopItem = await factory.Query("shop_items")
                .Where("id", shopItemId)
                .Where(q => q
                    .WhereNull("available_until")
                    .OrWhere("available_until", ">", DateTime.UtcNow))
                .FirstOrDefaultAsync<ShopItem>();
                
            if (shopItem == null)
            {
                await transaction.RollbackAsync();
                return (false, null, null, "í•´ë‹¹ ìƒì  ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ íŒë§¤ ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            
            // 3. ì¬ê³  í™•ì¸
            if (shopItem.IsLimited && shopItem.RemainingStock.HasValue && shopItem.RemainingStock.Value < quantity)
            {
                await transaction.RollbackAsync();
                return (false, null, null, "ìƒí’ˆì˜ ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            }
            
            // 4. ê°€ê²© ê³„ì‚°
            int totalPrice = shopItem.Price * quantity;
            
            // 5. í”Œë ˆì´ì–´ ë³´ìœ  í™”í í™•ì¸
            if (shopItem.CurrencyType == "gold" && player.Gold < totalPrice)
            {
                await transaction.RollbackAsync();
                return (false, null, null, "ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            }
            else if (shopItem.CurrencyType == "gems" && player.Gems < totalPrice)
            {
                await transaction.RollbackAsync();
                return (false, null, null, "ì ¬ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            }
            
            // 6. í™”í ì°¨ê°
            if (shopItem.CurrencyType == "gold")
            {
                player.Gold -= totalPrice;
                await factory.Query("players")
                    .Where("id", playerId)
                    .DecrementAsync("gold", totalPrice);
            }
            else
            {
                player.Gems -= totalPrice;
                await factory.Query("players")
                    .Where("id", playerId)
                    .DecrementAsync("gems", totalPrice);
            }
            
            // 7. ì¬ê³  ê°ì†Œ
            if (shopItem.IsLimited && shopItem.RemainingStock.HasValue)
            {
                await factory.Query("shop_items")
                    .Where("id", shopItemId)
                    .DecrementAsync("remaining_stock", quantity);
            }
            
            // 8. ì•„ì´í…œ ì§€ê¸‰
            var acquiredItems = new List<PlayerItem>();
            var now = DateTime.UtcNow;
            
            for (int i = 0; i < quantity; i++)
            {
                int playerItemId = await factory.Query("player_items").InsertGetIdAsync<int>(new
                {
                    player_id = playerId,
                    item_id = shopItem.Id,
                    acquired_at = now,
                    source = "shop_purchase"
                });
                
                acquiredItems.Add(new PlayerItem
                {
                    Id = playerItemId,
                    PlayerId = playerId,
                    ItemId = shopItem.Id,
                    AcquiredAt = now
                });
            }
            
            // 9. êµ¬ë§¤ ë¡œê·¸ ê¸°ë¡
            await factory.Query("purchase_logs").InsertAsync(new
            {
                player_id = playerId,
                shop_item_id = shopItemId,
                quantity = quantity,
                total_price = totalPrice,
                currency_type = shopItem.CurrencyType,
                purchased_at = now
            });
            
            await transaction.CommitAsync();
            
            return (true, player, acquiredItems, "êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            _logger.LogError(ex, "ì•„ì´í…œ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. PlayerId: {PlayerId}, ShopItemId: {ShopItemId}", playerId, shopItemId);
            return (false, null, null, "ì•„ì´í…œ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
}
```

### 5.9.4 ìƒì  ì»¨íŠ¸ë¡¤ëŸ¬

```csharp
// Controllers/ShopController.cs
[ApiController]
[Route("api/[controller]")]
public class ShopController : ControllerBase
{
    private readonly IShopService _shopService;

    public ShopController(IShopService shopService)
    {
        _shopService = shopService;
    }

    [HttpPost("items")]
    public async Task<ShopItemResponse> GetShopItems()
    {
        var (success, items, message) = await _shopService.GetShopItemsAsync();
        
        return new ShopItemResponse
        {
            Success = success,
            Items = items,
            Message = message
        };
    }

    [HttpPost("purchase")]
    public async Task<PurchaseResponse> PurchaseItem([FromBody] PurchaseRequest request)
    {
        if (request.Quantity <= 0)
        {
            return new PurchaseResponse
            {
                Success = false,
                Message = "êµ¬ë§¤ ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."
            };
        }
        
        var (success, player, items, message) = await _shopService.PurchaseItemAsync(
            request.PlayerId, 
            request.ShopItemId, 
            request.Quantity);
            
        return new PurchaseResponse
        {
            Success = success,
            UpdatedPlayer = player,
            AcquiredItems = items,
            Message = message
        };
    }
}
```

### 5.9.5 ìƒì  HTTP ìš”ì²­ í…ŒìŠ¤íŠ¸

```
### ìƒì  ì•„ì´í…œ ëª©ë¡ ì¡°íšŒ
POST https://localhost:5001/api/shop/items
Content-Type: application/json

{}

### ì•„ì´í…œ êµ¬ë§¤
POST https://localhost:5001/api/shop/purchase
Content-Type: application/json

{
  "playerId": 1,
  "shopItemId": 3,
  "quantity": 1
}
```
  

## 5.10 ì •ë¦¬

ì´ ì±•í„°ì—ì„œëŠ” ASP.NET Core Web API ê²Œì„ ì„œë²„ì—ì„œ MySQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—°ë™í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë´¤ë‹¤. MySqlConnectorì™€ SqlKataë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê³„ì¸µì„ êµ¬í˜„í•˜ê³ , ìˆ˜ì§‘í˜• RPG ê²Œì„ì— í•„ìš”í•œ ì—¬ëŸ¬ ê¸°ëŠ¥ì„ ê°œë°œí–ˆë‹¤.

ì£¼ìš” ë‚´ìš©:
- MySqlConnectorë¥¼ ì‚¬ìš©í•œ MySQL ì—°ê²° ë° ì¿¼ë¦¬ ì‹¤í–‰
- SqlKataë¥¼ í™œìš©í•œ íƒ€ì… ì•ˆì „í•œ ì¿¼ë¦¬ ë¹Œë” íŒ¨í„´ êµ¬í˜„
- íŠ¸ëœì­ì…˜ì„ í†µí•œ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€
- ì„±ëŠ¥ ìµœì í™” ê¸°ë²•
- ì‹¤ì œ ê²Œì„ ê¸°ëŠ¥(í”Œë ˆì´ì–´ ê´€ë¦¬, ìƒì  ì‹œìŠ¤í…œ ë“±) êµ¬í˜„ ì˜ˆì œ

ë‹¤ìŒ ì±•í„°ì—ì„œëŠ” Redisë¥¼ ì‚¬ìš©í•œ ìºì‹±ê³¼ ì‹¤ì‹œê°„ ê¸°ëŠ¥ êµ¬í˜„ì— ëŒ€í•´ ì•Œì•„ë³¼ ê²ƒì´ë‹¤.  
  

